<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tensor Operations</title><link rel="stylesheet" href="../../book.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js" integrity="sha384-zbcZAIxlvJtNE3Dp5nxLXdXtXyxwOdnILY1TDPVmKFhl4r4nSUG1r8bcFXGVa4Te" crossorigin="anonymous"></script>
    <script src="../../static/katex/katex.min.js"></script>
    <script src="../../static/math.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../-verso-js/popper.js"></script>
    <script src="../../-verso-js/tippy.js"></script>
    <link rel="stylesheet" href="../../static/theme.css">
    <link rel="stylesheet" href="../../static/inter/inter.css">
    <link rel="stylesheet" href="../../static/firacode/fira_code.css">
    <link rel="stylesheet" href="../../static/katex/katex.min.css">
    <link rel="stylesheet" href="../../-verso-css/tippy-border.css">
    <style>
div.collapsible-hint {
  margin: 5px 0;
}

div.collapsible-hint-header {
  padding: 2px;
  font-size: medium;
  cursor: pointer;
  position: relative;
}

div.collapsible-hint-header::after {
  content: "⊢";
  position: absolute;
  left: 50px;
  transition: transform 0.3s ease;
}

div.collapsible-hint-content {
  border: 1px solid white;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

div.collapsible-hint.expanded .collapsible-hint-content {
  max-height: 500px; /* Adjust this value depending on the content's height */
  border: 1px solid lightgrey;
}

div.collapsible-hint.expanded .collapsible-hint-header::after {
  transform: rotate(90deg); /* Rotate to show ">" when expanded */
}
</style><style>

.hl.lean {
  white-space: pre;
  font-weight: normal;
  font-style: normal;
}

.hl.lean .keyword {
  font-weight : bold;
}

.hl.lean .var {
  font-style: italic;
  position: relative;
}

.hover-container {
  width: 0;
  height: 0;
  position: relative;
  display: inline;
}

.hl.lean .hover-info {
  white-space: normal;
}

.hl.lean .token .hover-info {
  display: none;
  position: absolute;
  background-color: #e5e5e5;
  border: 1px solid black;
  padding: 0.5em;
  z-index: 300;
  font-size: inherit;
}

.hl.lean .hover-info.messages {
  max-height: 10em;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-gutter: stable;
  padding: 0 0.5em 0 0;
  display: block;
}

.hl.lean .hover-info code {
  white-space: pre-wrap;
}

.hl.lean .hover-info.messages > code {
  padding: 0.5em;
  display: block;
  width: fit-content;
}

.hl.lean .hover-info.messages > code:only-child {
  margin: 0;
}

.hl.lean .hover-info.messages > code {
  margin: 0.1em;
}

.hl.lean .hover-info.messages > code:not(:first-child) {
  margin-top: 0em;
}

/*
@media (hover: hover) {
  .hl.lean .has-info:hover > .hover-container > .hover-info:not(.tactic *),
  .hl.lean .tactic:has(> .tactic-toggle:checked) .has-info:hover > .hover-container > .hover-info,
  .hl.lean .token:hover > .hover-container > .hover-info:not(.has-info *):not(.tactic *),
  .hl.lean .tactic:has(> .tactic-toggle:checked) .token:hover > .hover-container > .hover-info:not(.has-info *) {
    display: inline-block;
    position: absolute;
    top: 1em;
    font-weight: normal;
    font-style: normal;
    width: min-content;
  }
}
*/

.hl.lean.block {
  display: block;
}

.hl.lean.inline {
  display: inline;
}

.hl.lean .token {
  transition: all 0.25s; /* Slight fade for highlights */
}

@media (hover: hover) {
  .hl.lean .token.binding-hl, .hl.lean .literal.string:hover {
    background-color: #eee;
    border-radius: 2px;
    transition: none;
  }
}


.hl.lean .has-info {
  text-decoration-style: wavy;
  text-decoration-line: underline;
  text-decoration-thickness: 0.1rem;
}

.hl.lean .has-info .hover-info {
  display: none;
  position: absolute;
  transform: translate(0.25rem, 0.3rem);
  border: 1px solid black;
  padding: 0.5em;
  z-index: 400;
  text-align: left;
}

.hl.lean .has-info.error {
  text-decoration-color: red;
}

@media (hover: hover) {
  .hl.lean .has-info.error:hover {
    background-color: #ffb3b3;
  }
}

.hl.lean .hover-info.messages > code.error {
  background-color: #e5e5e5;
  border-left: 0.2em solid #ffb3b3;
}

.tippy-box[data-theme~='error'] .hl.lean .hover-info.messages > code.error {
  background: none;
  border: none;
}

.error pre {
    color: red;
}

.hl.lean .has-info.warning {
  text-decoration-color: #efd871;
}

@media (hover: hover) {
  .hl.lean .has-info.warning:hover {
    background-color: #efd871;
  }
}

.hl.lean .hover-info.messages > code.warning {
  background-color: #efd871;
}

.hl.lean .hover-info.messages > code.error {
  background-color: #e5e5e5;
  border-left: 0.2em solid #efd871;
}

.tippy-box[data-theme~='warning'] .hl.lean .hover-info.messages > code.warning {
  background: none;
  border: none;
}


.hl.lean .has-info.info {
  text-decoration-color: blue;
}

@media (hover: hover) {
  .hl.lean .has-info.info:hover {
    background-color: #4777ff;
  }
}


.hl.lean .hover-info.messages > code.info {
  background-color: #e5e5e5;
  border-left: 0.2em solid #4777ff;
}

.tippy-box[data-theme~='info'] .hl.lean .hover-info.messages > code.info {
  background: none;
  border: none;
}

.hl.lean div.docstring {
  font-family: sans-serif;
  white-space: normal;
  max-width: 40em;
  width: max-content;
}

.hl.lean div.docstring > :last-child {
  margin-bottom: 0;
}

.hl.lean .hover-info .sep {
  display: block;
  width: auto;
  margin-left: 1em;
  margin-right: 1em;
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  padding: 0;
  height: 1px;
  border-top: 1px solid #ccc;
}

.hl.lean code {
  font-family: monospace;
}

.hl.lean .tactic-state {
  display: none;
  position: relative;
  left: 2em;
  width: fit-content;
  border: 1px solid #888888;
  border-radius: 0.1em;
  padding: 0.5em;
  font-family: sans-serif;
  background-color: #ffffff;
  z-index: 200;
}

.hl.lean.popup .tactic-state {
  position: static;
  display: block;
  width: auto;
  border: none;
  padding: 0.5em;
  font-family: sans-serif;
  background-color: #ffffff;
}


.hl.lean .tactic {
  position: relative;
}

.hl.lean .tactic-toggle:checked ~ .tactic-state {
  display: block;
}

/*
@media (hover: hover) {
  .hl.lean .tactic:hover > .tactic-toggle:not(:checked) ~ .tactic-state {
    display: block;
    position: absolute;
    left: 0;
    transform: translate(0.25rem, 0);
    z-index: 250;
  }
}
*/

.hl.lean .tactic > label {
  position: relative;
  transition: all 0.5s;
}

@media (hover: hover) {
  .hl.lean .tactic > label:hover {
    border-bottom: 1px dotted #bbbbbb;
  }
}

.hl.lean .tactic-toggle {
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  height: 0;
  width: 0;
  z-index: -10;
}

.hl.lean .tactic > label::after {
  content: "";
  border: 1px solid #bbbbbb;
  border-radius: 1em;
  height: 0.25em;
  vertical-align: middle;
  width: 0.6em;
  margin-left: 0.1em;
  margin-right: 0.1em;
  display: inline-block;
  transition: all 0.5s;
}

/*
@media (hover: hover) {
  .hl.lean .tactic > label:hover::after {
    border: 1px solid #aaaaaa;
    background-color: #aaaaaa;
    transition: all 0.5s;
  }
}
*/

.hl.lean .tactic > label:has(+ .tactic-toggle:checked)::after {
  border: 1px solid #999999;
  background-color: #999999;
  transition: all 0.5s;
}

.hl.lean .tactic-state .goal + .goal {
  margin-top: 1.5em;
}

.hl.lean .tactic-state summary {
  margin-left: -0.5em;
}

.hl.lean .tactic-state details {
  padding-left: 0.5em;
}

.hl.lean .tactic-state .goal-name::before {
  font-style: normal;
  content: "case ";
}

.hl.lean .tactic-state .goal-name {
  font-style: italic;
  font-family: monospace;
}

.hl.lean .tactic-state .hypotheses td.colon {
  text-align: center;
  min-width: 1em;
}

.hl.lean .tactic-state .hypotheses td.name {
  text-align: right;
}

.hl.lean .tactic-state .hypotheses td.name,
.hl.lean .tactic-state .hypotheses td.type,
.hl.lean .tactic-state .conclusion .type {
  font-family: monospace;
}

.tippy-box[data-theme~='lean'] {
  background-color: #e5e5e5;
  color: black;
  border: 1px solid black;
}
.tippy-box[data-theme~='lean'][data-placement^='top'] > .tippy-arrow::before {
  border-top-color: #e5e5e5;
}
.tippy-box[data-theme~='lean'][data-placement^='bottom'] > .tippy-arrow::before {
  border-bottom-color: #e5e5e5;
}
.tippy-box[data-theme~='lean'][data-placement^='left'] > .tippy-arrow::before {
  border-left-color: #e5e5e5;
}
.tippy-box[data-theme~='lean'][data-placement^='right'] > .tippy-arrow::before {
  border-right-color: #e5e5e5;
}

.tippy-box[data-theme~='message'][data-placement^='top'] > .tippy-arrow::before {
  border-top-color: #e5e5e5;
  border-width: 11px 11px 0;
}
.tippy-box[data-theme~='message'][data-placement^='top'] > .tippy-arrow::after {
  bottom: -11px;
  border-width: 11px 11px 0;
}
.tippy-box[data-theme~='message'][data-placement^='bottom'] > .tippy-arrow::before {
  border-width: 0 11px 11px;
}
.tippy-box[data-theme~='message'][data-placement^='bottom'] > .tippy-arrow::after {
  top: -11px;
  border-width: 0 11px 11px;
}
.tippy-box[data-theme~='message'][data-placement^='left'] > .tippy-arrow::before {
  border-left-color: #e5e5e5;
  border-width: 11px 0 11px 11px;
}
.tippy-box[data-theme~='message'][data-placement^='left'] > .tippy-arrow::after {
  right: -11px;
  border-width: 11px 0 11px 11px;
}

.tippy-box[data-theme~='message'][data-placement^='right'] > .tippy-arrow::before {
  border-right-color: #e5e5e5;
  border-width: 11px 11px 11px 0;
}
.tippy-box[data-theme~='message'][data-placement^='right'] > .tippy-arrow::after {
  left: -11px;
  border-width: 11px 11px 11px 0;
}



.tippy-box[data-theme~='warning'] {
  background-color: #e5e5e5;
  color: black;
  border: 3px solid #efd871;
}

.tippy-box[data-theme~='error'] {
  background-color: #e5e5e5;
  color: black;
  border: 3px solid #f7a7af;
}

.tippy-box[data-theme~='info'] {
  background-color: #e5e5e5;
  color: black;
  border: 3px solid #99b3c2;
}



.tippy-box[data-theme~='tactic'] {
  background-color: white;
  color: black;
  border: 1px solid black;
}
.tippy-box[data-theme~='tactic'][data-placement^='top'] > .tippy-arrow::before {
  border-top-color: white;
}
.tippy-box[data-theme~='tactic'][data-placement^='bottom'] > .tippy-arrow::before {
  border-bottom-color: white;
}
.tippy-box[data-theme~='tactic'][data-placement^='left'] > .tippy-arrow::before {
  border-left-color: white;
}
.tippy-box[data-theme~='tactic'][data-placement^='right'] > .tippy-arrow::before {
  border-right-color: white;
}

</style><style>
div.TODO {
  border: 5px solid red;
  position: relative;
}
div.TODO::before {
  content: "TODO";
  position: absolute;
  top: 0;
  right: 0;
  color: red;
  font-size: large;
  font-weight: bold;
  transform: rotate(-90deg) translate(-2em);
}
</style><style>
div.collapsible {
  margin: 5px 0;
}

div.collapsible-header {
  padding: 2px;
  font-size: medium;
  cursor: pointer;
  position: relative;
}

div.collapsible-header::after {
  content: "⊢";
  position: absolute;
  left: 60px;
  transition: transform 0.3s ease;
}

div.collapsible-content {
  border: 1px solid white;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

div.collapsible.expanded .collapsible-content {
  max-height: 500px; /* Adjust this value depending on the content's height */
  border: 1px solid lightgrey;
}

div.collapsible.expanded .collapsible-header::after {
  transform: rotate(90deg); /* Rotate to show ">" when expanded */
}
</style><script>
      
window.onload = () => {

    // Don't show hovers inside of closed tactic states
    function blockedByTactic(elem) {
      let parent = elem.parentNode;
      while (parent && "classList" in parent) {
        if (parent.classList.contains("tactic")) {
          const toggle = parent.querySelector("input.tactic-toggle");
          if (toggle) {
            return !toggle.checked;
          }
        }
        parent = parent.parentNode;
      }
      return false;
    }

    function blockedByTippy(elem) {
      // Don't show a new hover until the old ones are all closed.
      // Scoped to the nearest "top-level block" to avoid being O(n) in the size of the document.
      var block = elem;
      const topLevel = new Set(["section", "body", "html", "nav", "header"]);
      while (block.parentNode && !topLevel.has(block.parentNode.nodeName.toLowerCase())) {
        block = block.parentNode;
      }
      for (const child of block.querySelectorAll(".token, .has-info")) {
        if (child._tippy && child._tippy.state.isVisible) { return true };
      }
      return false;
    }

    for (const c of document.querySelectorAll(".hl.lean .token")) {
        if (c.dataset.binding != "") {
            c.addEventListener("mouseover", (event) => {
                if (blockedByTactic(c)) {return;}
                const context = c.closest(".hl.lean").dataset.leanContext;
                for (const example of document.querySelectorAll(".hl.lean")) {
                    if (example.dataset.leanContext == context) {
                        for (const tok of example.querySelectorAll(".token")) {
                            if (c.dataset.binding == tok.dataset.binding) {
                                tok.classList.add("binding-hl");
                            }
                        }
                    }
                }
            });
        }
        c.addEventListener("mouseout", (event) => {
            for (const tok of document.querySelectorAll(".hl.lean .token")) {
                tok.classList.remove("binding-hl");
            }
        });
    }
    /* Render docstrings */
    if ('undefined' !== typeof marked) {
        for (const d of document.querySelectorAll("code.docstring, pre.docstring")) {
            const str = d.innerText;
            const html = marked.parse(str);
            const rendered = document.createElement("div");
            rendered.classList.add("docstring");
            rendered.innerHTML = html;
            d.parentNode.replaceChild(rendered, d);
        }
    }
    // Add hovers
    fetch("/-verso-docs.json").then((resp) => resp.json()).then((versoDocData) => {

      const defaultTippyProps = {
        /* DEBUG -- remove the space: * /
        onHide(any) { return false; },
        trigger: "click",
        // */
        theme: "lean",
        maxWidth: "none",
        appendTo: () => document.body,
        interactive: true,
        delay: [100, null],
        ignoreAttributes: true,
        onShow(inst) {
          if (inst.reference.querySelector(".hover-info") || "versoHover" in inst.reference.dataset) {
            if (blockedByTactic(inst.reference)) { return false };
            if (blockedByTippy(inst.reference)) { return false; }
          } else { // Nothing to show here!
            return false;
          }
        },
        content (tgt) {
          const content = document.createElement("span");
          content.className = "hl lean";
          content.style.display = "block";
          content.style.maxHeight = "300px";
          content.style.overflowY = "auto";
          content.style.overflowX = "hidden";
          const hoverId = tgt.dataset.versoHover;
          const hoverInfo = tgt.querySelector(".hover-info");
          if (hoverId) { // Docstrings from the table
            // TODO stop doing an implicit conversion from string to number here
            let data = versoDocData[hoverId];
            if (data) {
              const info = document.createElement("span");
              info.className = "hover-info";
              info.style.display = "block";
              info.innerHTML = data;
              content.appendChild(info);
              /* Render docstrings - TODO server-side */
              if ('undefined' !== typeof marked) {
                  for (const d of content.querySelectorAll("code.docstring, pre.docstring")) {
                      const str = d.innerText;
                      const html = marked.parse(str);
                      const rendered = document.createElement("div");
                      rendered.classList.add("docstring");
                      rendered.innerHTML = html;
                      d.parentNode.replaceChild(rendered, d);
                  }
              }
            } else {
              content.innerHTML = "Failed to load doc ID: " + hoverId;
            }
          } else if (hoverInfo) { // The inline info, still used for compiler messages
            content.appendChild(hoverInfo.cloneNode(true));
          }
          return content;
        }
      };

      const addTippy = (selector, props) => {
        tippy(selector, Object.assign({}, defaultTippyProps, props));
      };
      addTippy('.hl.lean .const.token, .hl.lean .keyword.token, .hl.lean .literal.token', {theme: 'lean'});
      addTippy('.hl.lean .has-info.warning', {theme: 'warning message'});
      addTippy('.hl.lean .has-info.info', {theme: 'info message'});
      addTippy('.hl.lean .has-info.error', {theme: 'error message'});

      tippy('.hl.lean .tactic', {
        allowHtml: true,
        /* DEBUG -- remove the space: * /
        onHide(any) { return false; },
        trigger: "click",
        // */
        maxWidth: "none",
        onShow(inst) {
          const toggle = inst.reference.querySelector("input.tactic-toggle");
          if (toggle && toggle.checked) {
            return false;
          }
          if (blockedByTippy(inst.reference)) { return false; }
        },
        theme: "tactic",
        placement: 'bottom-start',
        content (tgt) {
          const content = document.createElement("span");
          const state = tgt.querySelector(".tactic-state").cloneNode(true);
          state.style.display = "block";
          content.appendChild(state);
          content.style.display = "block";
          content.className = "hl lean popup";
          return content;
        }
      });
  });
}
</script>
    </head>
  <body>
    <div class="with-toc">
      <header>
        <h1>
          <a href="../../">Scientific Computing in Lean</a></h1>
        <div id="controls">
          <label for="toggle-toc" id="toggle-toc-click">📖</label></div>
        <div id="print">
          <span>🖨</span></div>
        </header>
      <nav id="toc">
        <input type="checkbox" id="toggle-toc" checked="checked"><ol>
          <li>
            <a href="../../Introduction#Scientific-Computing-in-Lean--Introduction">Introduction</a><ol>
              <li>
                <a href="../../Introduction/About#Scientific-Computing-in-Lean--Introduction--About">About</a></li>
              <li>
                <a href="../../Introduction/Introduction#Scientific-Computing-in-Lean--Introduction--Introduction">Introduction</a><ol>
                  <li>
                    <a href="../../Introduction/Introduction#Scientific-Computing-in-Lean--Introduction--Introduction--Why-Lean-for-Scientific-Computing">Why Lean for Scientific Computing?</a></li>
                  </ol>
                </li>
              </ol>
            </li>
          <li>
            <a href="../../Working-with-Arrays#Scientific-Computing-in-Lean--Working-with-Arrays">Working with Arrays</a><ol>
              <li>
                <a href="../../Working-with-Arrays/Basic-Operations#Scientific-Computing-in-Lean--Working-with-Arrays--Basic-Operations">Basic Operations</a><ol>
                  <li>
                    <a href="../../Working-with-Arrays/Basic-Operations#Scientific-Computing-in-Lean--Working-with-Arrays--Basic-Operations--Reshaping-Arrays">Reshaping Arrays</a></li>
                  <li>
                    <a href="../../Working-with-Arrays/Basic-Operations#Scientific-Computing-in-Lean--Working-with-Arrays--Basic-Operations--Exercises">Exercises</a></li>
                  </ol>
                </li>
              <li>
                <a href="../../Working-with-Arrays/Tensor-Operations#Scientific-Computing-in-Lean--Working-with-Arrays--Tensor-Operations">Tensor Operations</a><ol>
                  <li>
                    <a href="../../Working-with-Arrays/Tensor-Operations#Scientific-Computing-in-Lean--Working-with-Arrays--Tensor-Operations--Transformations-and-Reductions">Transformations and Reductions</a></li>
                  <li>
                    <a href="../../Working-with-Arrays/Tensor-Operations#Scientific-Computing-in-Lean--Working-with-Arrays--Tensor-Operations--Convolution-and-Operations-on-Indices">Convolution and Operations on Indices</a></li>
                  <li>
                    <a href="../../Working-with-Arrays/Tensor-Operations#Scientific-Computing-in-Lean--Working-with-Arrays--Tensor-Operations--Pooling-and-Difficulties-with-Dependent-Types">Pooling and Difficulties with Dependent Types</a></li>
                  <li>
                    <a href="../../Working-with-Arrays/Tensor-Operations#Scientific-Computing-in-Lean--Working-with-Arrays--Tensor-Operations--Simple-Neural-Network">Simple Neural Network</a></li>
                  </ol>
                </li>
              <li>
                <a href="../../Working-with-Arrays/Optimizing-Array-Expressions#Scientific-Computing-in-Lean--Working-with-Arrays--Optimizing-Array-Expressions">Optimizing Array Expressions</a><ol>
                  <li>
                    <a href="../../Working-with-Arrays/Optimizing-Array-Expressions#Scientific-Computing-in-Lean--Working-with-Arrays--Optimizing-Array-Expressions--Loop-Fusion">Loop Fusion</a></li>
                  <li>
                    <a href="../../Working-with-Arrays/Optimizing-Array-Expressions#Scientific-Computing-in-Lean--Working-with-Arrays--Optimizing-Array-Expressions--Optimizing-Array-Indexing">Optimizing Array Indexing</a></li>
                  </ol>
                </li>
              </ol>
            </li>
          <li>
            <a href="../../-Differentiation#Scientific-Computing-in-Lean---Differentiation">🚧 Differentiation</a><ol>
              <li>
                <a href="../../-Differentiation/Symbolic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Symbolic-Differentiation">Symbolic Differentiation</a><ol>
                  <li>
                    <a href="../../-Differentiation/Symbolic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Symbolic-Differentiation--Notation">Notation</a></li>
                  <li>
                    <a href="../../-Differentiation/Symbolic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Symbolic-Differentiation--Examples">Examples</a></li>
                  <li>
                    <a href="../../-Differentiation/Symbolic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Symbolic-Differentiation--Gradient">Gradient</a></li>
                  <li>
                    <a href="../../-Differentiation/Symbolic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Symbolic-Differentiation--Derivative-Rules">Derivative Rules</a></li>
                  <li>
                    <a href="../../-Differentiation/Symbolic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Symbolic-Differentiation--Differentiating-Division-Log-Sqrt-">Differentiating Division, Log, Sqrt, ...</a></li>
                  <li>
                    <a href="../../-Differentiation/Symbolic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Symbolic-Differentiation--Abstract-Vector-Spaces">Abstract Vector Spaces</a></li>
                  </ol>
                </li>
              <li>
                <a href="../../-Differentiation/Automatic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Automatic-Differentiation">Automatic Differentiation</a><ol>
                  <li>
                    <a href="../../-Differentiation/Automatic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Automatic-Differentiation--Forward-Mode">Forward Mode</a></li>
                  <li>
                    <a href="../../-Differentiation/Automatic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Automatic-Differentiation--Reverse-Mode">Reverse Mode</a></li>
                  <li>
                    <a href="../../-Differentiation/Automatic-Differentiation#Scientific-Computing-in-Lean---Differentiation--Automatic-Differentiation--Derivatives-of-Neural-Network-Layers">Derivatives of Neural Network Layers</a></li>
                  </ol>
                </li>
              <li>
                <a href="../../-Differentiation/Function-Transformation#Scientific-Computing-in-Lean---Differentiation--Function-Transformation">Function Transformation</a><ol>
                  <li>
                    <a href="../../-Differentiation/Function-Transformation#Scientific-Computing-in-Lean---Differentiation--Function-Transformation--User-Defined-Function-Transformation">User Defined Function Transformation</a></li>
                  <li>
                    <a href="../../-Differentiation/Function-Transformation#Scientific-Computing-in-Lean---Differentiation--Function-Transformation--Lambda-Theorems">Lambda Theorems</a></li>
                  <li>
                    <a href="../../-Differentiation/Function-Transformation#Scientific-Computing-in-Lean---Differentiation--Function-Transformation--Function-Theorems">Function Theorems</a></li>
                  <li>
                    <a href="../../-Differentiation/Function-Transformation#Scientific-Computing-in-Lean---Differentiation--Function-Transformation--Free-Variable-Theorems">Free Variable Theorems</a></li>
                  <li>
                    <a href="../../-Differentiation/Function-Transformation#Scientific-Computing-in-Lean---Differentiation--Function-Transformation--Morphism-Theorems">Morphism Theorems</a></li>
                  <li>
                    <a href="../../-Differentiation/Function-Transformation#Scientific-Computing-in-Lean---Differentiation--Function-Transformation--Advanced-Function-Theorems">Advanced Function Theorems</a></li>
                  </ol>
                </li>
              </ol>
            </li>
          <li>
            <a href="../../Examples#Scientific-Computing-in-Lean--Examples">Examples</a><ol>
              <li>
                <a href="../../Examples/Harmonic-Oscillator#Scientific-Computing-in-Lean--Examples--Harmonic-Oscillator">Harmonic Oscillator</a></li>
              </ol>
            </li>
          </ol>
        </nav>
      <main><section>
          <h1>
            Tensor Operations</h1>
          <p>
            In this chapter, we will demonstrate more advanced operations with arrays, such as transformations and reductions. To provide a concrete example, we will build a simple neural network. It's important to note that Lean/SciLean is not yet suitable for running and training neural networks, as it only runs on CPU and the current compiler does not produce the most efficient code. Nevertheless, I believe that writing a simple neural network will nicely demonstrate Lean's expressivity. My secret hope is that this text will motivate someone to write a specialized compiler that will translate a subset of Lean to GPUs.</p>
          <section>
            <h2 id="Scientific-Computing-in-Lean--Working-with-Arrays--Tensor-Operations--Transformations-and-Reductions">
              Transformations and Reductions</h2>
            <p>
              One common operation is to transform every element of an array. To do that, we can write a simple for loop. Recall that anytime you want to write imperative-style code, you have to start it with <code>Id.run do</code>, and to modify input <code>x</code> mutably, we have to introduce a new mutable variable <code>x'</code> and assign <code>x</code> to it:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-1260" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-1273">def</span> <span class="const token" data-binding="const-map" data-verso-hover="90">map</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">I</span> <span class="unknown token" data-binding="">:</span> <span class="sort token" data-binding="">Type</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-SciLean.IndexType" data-verso-hover="41">IndexType</span> <span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.13" data-verso-hover="84">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.17" data-verso-hover="91">f</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span> <span class="unknown token" data-binding="">→</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span> <span class="const token" data-binding="const-Id.run" data-verso-hover="6">Id.run</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-1354">do</span>
  <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLet-1359">let</span> <span class="keyword token" data-binding="kw-occ-null-1363">mut</span> <span class="var token" data-binding="var-_uniq.136" data-verso-hover="84">x'</span> <span class="unknown token" data-binding="">:=</span> <span class="var token" data-binding="var-_uniq.13" data-verso-hover="84">x</span>
  <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doFor-1377" data-verso-hover="8">for</span> <span class="var token" data-binding="var-_uniq.130" data-verso-hover="86">i</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doForDecl-1381">in</span> <span class="const token" data-binding="const-SciLean.fullRange" data-verso-hover="60">fullRange</span> <span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">I</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doFor-1377" data-verso-hover="8">do</span>
    <span class="var token" data-binding="var-_uniq.136" data-verso-hover="84">x'</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.130" data-verso-hover="86">i</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">:=</span> <span class="var token" data-binding="var-_uniq.17" data-verso-hover="91">f</span> <span class="var token" data-binding="var-_uniq.136" data-verso-hover="84">x'</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.130" data-verso-hover="86">i</span><span class="unknown token" data-binding="">]</span>
  <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doReturn-1424" data-verso-hover="9">return</span> <span class="var token" data-binding="var-_uniq.136" data-verso-hover="84">x'</span>
<span class="unknown token" data-binding=""></span></code><p>
              A new thing here is that we wrote this function polymorphically in the index type <code>I</code>. <code>{I : Type}</code> introduces a new type, and <code>[IndexType I]</code> adds a requirement that <code>I</code> behaves as an index. <code>IndexType</code> is a type class that allows us to do a bunch of things with <code>I</code>. We have already seen <code>size I</code>, which tells you the number of elements in <code>I</code>. There is also <code>IndexType.toFin</code> and <code>IndexType.fromFin</code>, which convert <code>i : I</code> into <code>toFin i : Fin (size I)</code> and <code>idx : Fin (size I)</code> to <code>fromFin idx : I</code>. So the function <code>toFin</code> allows you to linearize any index <code>I</code>, and it is the core function used to implement <code>DataArrayN</code>, as all elements of an array have to be stored linearly in memory.</p>
            <p>
              In fact, SciLean already provides this function under the name <code>mapMono</code>. The "mono" stands for the fact that the function <code>f</code> does not change the type; in our case, it accepts and returns <code>Float</code>. Also, this function is defined in the <code>DataArrayN</code> namespace, and because of that, we can use the familiar dot notation <code>x.mapMono</code>. As <code>mapMono</code> is polymorphic in the shape of the array, we can call it on vectors:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-2571" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span> <span class="unknown token" data-binding="">Scalar</span>
<span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">⊞[1.000000, 1.414214, 1.732051]
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-2591">#eval</span></span> <span class="unknown token" data-binding="">⊞[</span><span class="unknown token" data-binding="">1.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">2.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">3.0</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.mapMono" data-verso-hover="92">mapMono</span> <span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-2623">fun</span> <span class="var token" data-binding="var-_uniq.1495" data-verso-hover="79">x</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="const token" data-binding="const-SciLean.Scalar.sqrt" data-verso-hover="93">sqrt</span> <span class="var token" data-binding="var-_uniq.1495" data-verso-hover="79">x</span><span class="unknown token" data-binding="">)</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>⊞[1.000000, 1.414214, 1.732051]
</pre></div>
            <p>
              or matrices:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-2745" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span> <span class="unknown token" data-binding="">Scalar</span>
<span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">⊞[1.000000, 1.732051, 1.414214, 2.000000]
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-2765">#eval</span></span> <span class="unknown token" data-binding="">⊞[</span><span class="unknown token" data-binding="">1.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">2.0</span><span class="unknown token" data-binding="">;</span><span class="unknown token" data-binding="">3.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">4.0</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.mapMono" data-verso-hover="92">mapMono</span> <span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-2801">fun</span> <span class="var token" data-binding="var-_uniq.73" data-verso-hover="79">x</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="const token" data-binding="const-SciLean.Scalar.sqrt" data-verso-hover="93">sqrt</span> <span class="var token" data-binding="var-_uniq.73" data-verso-hover="79">x</span><span class="unknown token" data-binding="">)</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>⊞[1.000000, 1.732051, 1.414214, 2.000000]
</pre></div>
            <p>
              or higher-rank arrays:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-2947" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span> <span class="unknown token" data-binding="">Scalar</span>
<span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">⊞ i j k =&gt; (↑i).toFloat + 2 * (↑j).toFloat + 4 * (↑k).toFloat : Float^[2, 2, 2]</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.check-2967">#check</span></span> <span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.12" data-verso-hover="94">i</span> <span class="var token" data-binding="var-_uniq.17" data-verso-hover="94">j</span> <span class="var token" data-binding="var-_uniq.22" data-verso-hover="94">k</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="var token" data-binding="var-_uniq.12" data-verso-hover="94">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Nat.toFloat" data-verso-hover="76">toFloat</span> <span class="unknown token" data-binding="">+</span> <span class="unknown token" data-binding="">2</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.17" data-verso-hover="94">j</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Nat.toFloat" data-verso-hover="76">toFloat</span> <span class="unknown token" data-binding="">+</span> <span class="unknown token" data-binding="">4</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.22" data-verso-hover="94">k</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Nat.toFloat" data-verso-hover="76">toFloat</span><span class="unknown token" data-binding="">)</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>⊞ i j k =&gt; (↑i).toFloat + 2 * (↑j).toFloat + 4 * (↑k).toFloat : Float^[2, 2, 2]
</pre></div>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-3195" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span> <span class="unknown token" data-binding="">Scalar</span>
<span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">⊞[0.000000, 1.000000, 1.414214, 1.732051, 2.000000, 2.236068, 2.449490, 2.645751]
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-3215">#eval</span></span> <span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.12" data-verso-hover="94">i</span> <span class="var token" data-binding="var-_uniq.17" data-verso-hover="94">j</span> <span class="var token" data-binding="var-_uniq.22" data-verso-hover="94">k</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="var token" data-binding="var-_uniq.12" data-verso-hover="94">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Nat.toFloat" data-verso-hover="76">toFloat</span> <span class="unknown token" data-binding="">+</span> <span class="unknown token" data-binding="">2</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.17" data-verso-hover="94">j</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Nat.toFloat" data-verso-hover="76">toFloat</span> <span class="unknown token" data-binding="">+</span> <span class="unknown token" data-binding="">4</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.22" data-verso-hover="94">k</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Nat.toFloat" data-verso-hover="76">toFloat</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.mapMono" data-verso-hover="92">mapMono</span> <span class="const token" data-binding="const-SciLean.Scalar.sqrt" data-verso-hover="93">sqrt</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>⊞[0.000000, 1.000000, 1.414214, 1.732051, 2.000000, 2.236068, 2.449490, 2.645751]
</pre></div>
            <p>
              where <code>IndexType.toFin (i,j,k)</code> turns a structured index of type <code>Fin 2 × Fin 2 × Fin 2</code> to a linear index of type <code>Fin 8</code>, <code>.toFloat</code> converts it to <code>Float</code>, and finally <code>.map (fun x =&gt; sqrt x)</code> computes the square root of every element.</p>
            <p>
              An alternative to <code>mapMono</code> is <code>mapIdxMono</code>, which accepts a function <code>f : I → X → X</code>, so you can additionally use the index value to transform the array values:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-3859" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span> <span class="unknown token" data-binding="">Scalar</span>
<span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">⊞[0.000000, 1.000000, 1.414214]
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-3879">#eval</span></span> <span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">0</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="unknown token" data-binding="">3</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">|&gt;.</span><span class="const token" data-binding="const-SciLean.DataArrayN.mapIdxMono" data-verso-hover="95">mapIdxMono</span> <span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3916">fun</span> <span class="var token" data-binding="var-_uniq.1297" data-verso-hover="49">i</span> <span class="unknown token" data-binding="">_</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="var token" data-binding="var-_uniq.1297" data-verso-hover="49">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Nat.toFloat" data-verso-hover="76">toFloat</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">|&gt;.</span><span class="const token" data-binding="const-SciLean.DataArrayN.mapMono" data-verso-hover="92">mapMono</span> <span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-3952">fun</span> <span class="var token" data-binding="var-_uniq.1319" data-verso-hover="79">x</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="const token" data-binding="const-SciLean.Scalar.sqrt" data-verso-hover="93">sqrt</span> <span class="var token" data-binding="var-_uniq.1319" data-verso-hover="79">x</span><span class="unknown token" data-binding="">)</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>⊞[0.000000, 1.000000, 1.414214]
</pre></div>
            <p>
              where <code>0 : Float^[3]</code> creates a zero array of size 3, then <code>mapIdxMono (fun i _ =&gt; i.toFloat)</code> initializes every element to the value of its index, and finally <code>map (fun x =&gt; sqrt x)</code> computes the square root of every element.</p>
            <p>
              The next important operation with arrays is reduction, which runs over elements and reduces them using a provided binary operation. There are two main reductions, <code>x.foldl op init</code> and <code>x.reduceD op default</code>. The difference is that <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-SciLean.DataArrayN.foldl" data-verso-hover="96">SciLean.DataArrayN.foldl</span></code> uses <code>init</code> as the initial value that is updated with elements of the array <code>x</code>, while <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-SciLean.DataArrayN.reduceD" data-verso-hover="97">SciLean.DataArrayN.reduceD</span></code> uses only the elements of <code>x</code> and returns <code>default</code> if <code>x</code> happens to be empty:</p>
            <pre>x.fold op init = (op ... (op (op init x[0]) x[1]) ...n)
x.reduceD op default = (op ... (op (op x[0] x[1]) x[2]) ...)
</pre><p>
              There are also versions <code>x.reduce</code> where you do not have to provide the default element, but it is required that the element type <code>X</code> of the array <code>x : X^I</code> has an instance <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Inhabited" data-verso-hover="98">Inhabited</span></code>, which allows you to call <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Inhabited.default" data-verso-hover="63">Inhabited.default</span></code>, returning a default element of <code>X</code>. For example, <code class="hl lean inline" data-lean-context="examples"><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Inhabited.default" data-verso-hover="63">default</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">)</span></code> returns <code>0.0</code>.</p>
            <p>
              To sum all elements of an array:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">6.000000
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-5255">#eval</span></span> <span class="unknown token" data-binding="">⊞[</span><span class="unknown token" data-binding="">1.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">2.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">3.0</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.foldl" data-verso-hover="96">foldl</span> <span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">·</span><span class="unknown token" data-binding="">+</span><span class="unknown token" data-binding="">·</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">0</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>6.000000
</pre></div>
            <p>
              or to find the minimal element:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">1.000000
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-5398">#eval</span></span> <span class="unknown token" data-binding="">⊞[</span><span class="unknown token" data-binding="">1.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">2.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">3.0</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.reduce" data-verso-hover="99">reduce</span> <span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Min.min" data-verso-hover="100">min</span> <span class="unknown token" data-binding="">·</span> <span class="unknown token" data-binding="">·</span><span class="unknown token" data-binding="">)</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>1.000000
</pre></div>
            <p>
              notice that computing the minimal element with <code>fold</code> and <code>init:=0</code> would give you an incorrect answer.</p>
            <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">0.000000
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-5617">#eval</span></span> <span class="unknown token" data-binding="">⊞[</span><span class="unknown token" data-binding="">1.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">2.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">3.0</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.foldl" data-verso-hover="96">foldl</span> <span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Min.min" data-verso-hover="100">min</span> <span class="unknown token" data-binding="">·</span> <span class="unknown token" data-binding="">·</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">0</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>0.000000
</pre></div>
            <p>
              Putting it all together we can implement soft-max</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-5765" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span> <span class="unknown token" data-binding="">Scalar</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-5785">def</span> <span class="const token" data-binding="const-softMax" data-verso-hover="101">softMax</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">I</span> <span class="unknown token" data-binding="">:</span> <span class="sort token" data-binding="">Type</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-SciLean.IndexType" data-verso-hover="41">IndexType</span> <span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span>
  <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.7" data-verso-hover="79">r</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.15" data-verso-hover="84">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">:=</span> <span class="const token" data-binding="const-Id.run" data-verso-hover="6">Id.run</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.do-5874">do</span>
  <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLet-5879">let</span> <span class="var token" data-binding="var-_uniq.120" data-verso-hover="79">m</span> <span class="unknown token" data-binding="">:=</span> <span class="var token" data-binding="var-_uniq.15" data-verso-hover="84">x</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.reduce" data-verso-hover="99">reduce</span> <span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Max.max" data-verso-hover="102">max</span> <span class="unknown token" data-binding="">·</span> <span class="unknown token" data-binding="">·</span><span class="unknown token" data-binding="">)</span>
  <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLet-5911">let</span> <span class="var token" data-binding="var-_uniq.186" data-verso-hover="84">x</span> <span class="unknown token" data-binding="">:=</span> <span class="var token" data-binding="var-_uniq.15" data-verso-hover="84">x</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.mapMono" data-verso-hover="92">mapMono</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-5930">fun</span> <span class="var token" data-binding="var-_uniq.135" data-verso-hover="79">x</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="var token" data-binding="var-_uniq.135" data-verso-hover="79">x</span><span class="unknown token" data-binding="">-</span><span class="var token" data-binding="var-_uniq.120" data-verso-hover="79">m</span>
  <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLet-5945">let</span> <span class="var token" data-binding="var-_uniq.279" data-verso-hover="84">x</span> <span class="unknown token" data-binding="">:=</span> <span class="var token" data-binding="var-_uniq.186" data-verso-hover="84">x</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.mapMono" data-verso-hover="92">mapMono</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-5964">fun</span> <span class="var token" data-binding="var-_uniq.201" data-verso-hover="79">x</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="const token" data-binding="const-SciLean.Scalar.exp" data-verso-hover="103">exp</span> <span class="var token" data-binding="var-_uniq.7" data-verso-hover="79">r</span><span class="unknown token" data-binding="">*</span><span class="var token" data-binding="var-_uniq.201" data-verso-hover="79">x</span>
  <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLet-5983">let</span> <span class="var token" data-binding="var-_uniq.352" data-verso-hover="79">w</span> <span class="unknown token" data-binding="">:=</span> <span class="var token" data-binding="var-_uniq.279" data-verso-hover="84">x</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.reduce" data-verso-hover="99">reduce</span> <span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">·</span><span class="unknown token" data-binding="">+</span><span class="unknown token" data-binding="">·</span><span class="unknown token" data-binding="">)</span>
  <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doLet-6011">let</span> <span class="var token" data-binding="var-_uniq.434" data-verso-hover="84">x</span> <span class="unknown token" data-binding="">:=</span> <span class="var token" data-binding="var-_uniq.279" data-verso-hover="84">x</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-SciLean.DataArrayN.mapMono" data-verso-hover="92">mapMono</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-6030">fun</span> <span class="var token" data-binding="var-_uniq.367" data-verso-hover="79">x</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="var token" data-binding="var-_uniq.367" data-verso-hover="79">x</span><span class="unknown token" data-binding="">/</span><span class="var token" data-binding="var-_uniq.352" data-verso-hover="79">w</span>
  <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.doReturn-6045" data-verso-hover="9">return</span> <span class="var token" data-binding="var-_uniq.434" data-verso-hover="84">x</span>
<span class="unknown token" data-binding=""></span></code><p>
              where for numerical stablity we first find the maximal element <code>m</code> and subtract it from all the element. After that we procees with the standard definition of soft max. Of course, this is not the most efficient implementation of softmax. In later chapter, we will show how to transform it to a more efficient version.</p>
            <p>
              Very common reduction is to sum element or to multiply them. <strong>SciLean</strong> provides familiar notation for these</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-6494">def</span> <span class="const token" data-binding="const-x" data-verso-hover="104">x</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">⊞[</span><span class="unknown token" data-binding="">1.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">2.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">3.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">4.0</span><span class="unknown token" data-binding="">]</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-6524">def</span> <span class="const token" data-binding="const-B" data-verso-hover="105">B</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">⊞[</span><span class="unknown token" data-binding="">1.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">2.0</span><span class="unknown token" data-binding="">;</span><span class="unknown token" data-binding="">3.0</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">4.0</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">10.000000
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-6583">#eval</span></span> <span class="unknown token" data-binding="">∑</span> <span class="var token" data-binding="var-_uniq.10" data-verso-hover="106">i</span><span class="unknown token" data-binding="">,</span> <span class="const token" data-binding="const-x" data-verso-hover="107">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.10" data-verso-hover="106">i</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>10.000000
</pre></div>
            <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">24.000000
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-6668">#eval</span></span> <span class="unknown token" data-binding="">∏</span> <span class="var token" data-binding="var-_uniq.10" data-verso-hover="106">i</span><span class="unknown token" data-binding="">,</span> <span class="const token" data-binding="const-x" data-verso-hover="107">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.10" data-verso-hover="106">i</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>24.000000
</pre></div>
            <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">10.000000
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-6754">#eval</span></span> <span class="unknown token" data-binding="">∑</span> <span class="var token" data-binding="var-_uniq.10" data-verso-hover="94">i</span> <span class="var token" data-binding="var-_uniq.359" data-verso-hover="94">j</span><span class="unknown token" data-binding="">,</span> <span class="const token" data-binding="const-B" data-verso-hover="108">B</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.10" data-verso-hover="94">i</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.359" data-verso-hover="94">j</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>10.000000
</pre></div>
            <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">24.000000
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-6845">#eval</span></span> <span class="unknown token" data-binding="">∏</span> <span class="var token" data-binding="var-_uniq.10" data-verso-hover="94">i</span> <span class="var token" data-binding="var-_uniq.266" data-verso-hover="94">j</span><span class="unknown token" data-binding="">,</span> <span class="const token" data-binding="const-B" data-verso-hover="108">B</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.10" data-verso-hover="94">i</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.266" data-verso-hover="94">j</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>24.000000
</pre></div>
            <p>
              <strong>Note for Mathlib users: For performance reasons SciLean defines sums and products with <code>IndexType</code> instead of <code>Finset</code>. Therefore this notation is different from the one defined in <code>BigOperators</code> namespace.</strong></p>
            <p>
              We can define commong matrix operations like matrix-vector multiplication</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-7203">def</span> <span class="const token" data-binding="const-matMul" data-verso-hover="109">matMul</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span> <span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Nat" data-verso-hover="5">Nat</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.25" data-verso-hover="59">A</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.31" data-verso-hover="57">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span>
  <span class="unknown token" data-binding="">⊞</span> <span class="var token" data-binding="var-_uniq.42" data-verso-hover="32">i</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="unknown token" data-binding="">∑</span> <span class="var token" data-binding="var-_uniq.52" data-verso-hover="58">j</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.25" data-verso-hover="59">A</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.42" data-verso-hover="32">i</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.52" data-verso-hover="58">j</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.31" data-verso-hover="57">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.52" data-verso-hover="58">j</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><p>
              or trace</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-7316">def</span> <span class="const token" data-binding="const-trace" data-verso-hover="110">trace</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Nat" data-verso-hover="5">Nat</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.22" data-verso-hover="111">A</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span>
  <span class="unknown token" data-binding="">∑</span> <span class="var token" data-binding="var-_uniq.376" data-verso-hover="32">i</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.22" data-verso-hover="111">A</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.376" data-verso-hover="32">i</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.376" data-verso-hover="32">i</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code></section>
          <section>
            <h2 id="Scientific-Computing-in-Lean--Working-with-Arrays--Tensor-Operations--Convolution-and-Operations-on-Indices">
              Convolution and Operations on Indices</h2>
            <p>
              The fundamental operation in machine learning is convolution. The first attempt at writing convolution might look like this:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-7606">def</span> <span class="const token" data-binding="const-conv1d" data-verso-hover="112">conv1d</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span> <span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">k</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Nat" data-verso-hover="5">Nat</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.13" data-verso-hover="31">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.19" data-verso-hover="113">w</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">k</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span>
    <span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.29" data-verso-hover="32">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="unknown token" data-binding="">∑</span> <span class="var token" data-binding="var-_uniq.38" data-verso-hover="114">j</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">k</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.19" data-verso-hover="113">w</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.38" data-verso-hover="114">j</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.13" data-verso-hover="31">x</span><span class="unknown token" data-binding="">[</span><span class="has-info error"><span class="hover-container"><span class="hover-info messages"><code class="message error">(deterministic) timeout at `typeclass`, maximum number of heartbeats (20000) has been reached
Use `set_option synthInstance.maxHeartbeats &lt;num&gt;` to set the limit.
Additional diagnostic information may be available using the `set_option diagnostics true` command.</code></span></span><span class="unknown token" data-binding="">i</span></span><span class="unknown token" data-binding="">-</span><span class="unknown token" data-binding="">j</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><div class="error">
              <pre>(deterministic) timeout at `typeclass`, maximum number of heartbeats (20000) has been reached
Use `set_option synthInstance.maxHeartbeats &lt;num&gt;` to set the limit.
Additional diagnostic information may be available using the `set_option diagnostics true` command.
</pre></div>
            <p>
              TODO: This is a bad error :( It should say that it failed to synthesize <code>HSub (Fin n) (Fin k) _</code></p>
            <p>
              This error arises because Lean can't infer the subtraction operation between the types <code>Fin n</code> and <code>Fin k</code>, which would produce some unknown type <code>?m</code>. This makes sense, what does it mean to subtract <code>j : Fin k</code> from <code>i : Fin n</code>? Because we are accessing elements of <code>x</code>, we probably want the result to be <code>Fin n</code>, but what do we do if <code>i - j</code> is smaller than zero? We need to do something more involved when performing operations on indices that have their range specified in their type.</p>
            <p>
              Let's step back a bit and look at the type of the kernel <code>w : Float^[k]</code>. We index it with numbers <code>0,...,k-1</code>, but that is not how we usually think of kernels. We would rather index them by <code>-k,...,-1,0,1,...,k</code>. SciLean provides useful notation for this: <code>Float^[[-k:k]]</code>, which stands for <code>DataArrayN Float (Set.Icc (-k) k)</code> and <code>Set.Icc (-k) k</code> is a closed interval with endpoints <code>-k</code> and <code>k</code>. Because here we consider <code>k</code> to be an integer, then <code>Set.Icc (-k) k</code> is exactly the set of <code>-k,...,-1,0,1,...,k</code>. Recall that <code>i : Fin n</code> is a pair of the value <code>i.1 : ℕ</code> and proof <code>i.2 : i.1 &lt; n</code>. Similarly, <code>i : Set.Icc (-k) k</code> is a pair <code>i.1 : ℤ</code> and proof <code>i.2 : -k ≤ i.1 ∧ i.1 ≤ k</code>. The type for a two-dimensional kernel would be <code>Float^[[-k:k],[-k:k]]</code>, which stands for <code>DataArrayN Float (Set.Icc (-k) k × Set.Icc (-k) k)</code>.</p>
            <p>
              Now, instead of writing <code>i-j</code>, we want to shift the index <code>i : Fin n</code> by the index <code>j</code> and obtain another index of type <code>Fin n</code>. Let's define a general function <code>shift</code> that shifts <code>Fin n</code> by an arbitrary integer:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-9668">def</span> <span class="const token" data-binding="const-Fin.shift" data-verso-hover="115">Fin.shift</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.3" data-verso-hover="4">n</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.5" data-verso-hover="32">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.3" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.7" data-verso-hover="116">j</span> <span class="unknown token" data-binding="">:</span> <span class="unknown token" data-binding="">ℤ</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.3" data-verso-hover="4">n</span> <span class="unknown token" data-binding="">:=</span>
    <span class="unknown token" data-binding="">{</span> <span class="const token" data-binding="const-Fin.val" data-verso-hover="117">val</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Int.ofNat" data-verso-hover="118">Int.ofNat</span> <span class="var token" data-binding="var-_uniq.5" data-verso-hover="32">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span> <span class="unknown token" data-binding="">+</span> <span class="var token" data-binding="var-_uniq.7" data-verso-hover="116">j</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">%</span> <span class="var token" data-binding="var-_uniq.3" data-verso-hover="4">n</span> <span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Int.toNat" data-verso-hover="119">toNat</span><span class="unknown token" data-binding="">,</span> <span class="const token" data-binding="const-Fin.isLt" data-verso-hover="120">isLt</span> <span class="unknown token" data-binding="">:=</span> <span class="keyword token" data-binding="kw-occ-SciLean.termSorry_proof-9774" data-verso-hover="67">sorry_proof</span> <span class="unknown token" data-binding="">}</span>
<span class="unknown token" data-binding=""></span></code><p>
              Here, <code>%</code> is positive modulo on integers, and we again omitted the proof that the result is indeed smaller than <code>n</code>. It is not a hard proof, but the purpose of this text is not to teach you how to prove theorems in Lean but rather how to use Lean as a programming language, and omitting proofs is a perfectly valid approach.</p>
            <p>
              Now we can write one-dimensional convolution as:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-10177">def</span> <span class="const token" data-binding="const-conv1d" data-verso-hover="121">conv1d</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span> <span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">k</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Nat" data-verso-hover="5">Nat</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.340" data-verso-hover="122">w</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">-</span><span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">k</span><span class="unknown token" data-binding="">:</span><span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">k</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.347" data-verso-hover="31">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span>
    <span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.357" data-verso-hover="32">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="unknown token" data-binding="">∑</span> <span class="var token" data-binding="var-_uniq.367" data-verso-hover="123">j</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.340" data-verso-hover="122">w</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.367" data-verso-hover="123">j</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.347" data-verso-hover="31">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.357" data-verso-hover="32">i</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Fin.shift" data-verso-hover="115">shift</span> <span class="var token" data-binding="var-_uniq.367" data-verso-hover="123">j</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><p>
              This immediately generalizes to two dimensions:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-10366">def</span> <span class="const token" data-binding="const-conv2d" data-verso-hover="124">conv2d</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span> <span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span> <span class="var token" data-binding="var-_uniq.6" data-verso-hover="4">k</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Nat" data-verso-hover="5">Nat</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.394" data-verso-hover="125">w</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">-</span><span class="var token" data-binding="var-_uniq.6" data-verso-hover="4">k</span><span class="unknown token" data-binding="">:</span><span class="var token" data-binding="var-_uniq.6" data-verso-hover="4">k</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">-</span><span class="var token" data-binding="var-_uniq.6" data-verso-hover="4">k</span><span class="unknown token" data-binding="">:</span><span class="var token" data-binding="var-_uniq.6" data-verso-hover="4">k</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.410" data-verso-hover="59">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span>
    <span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.421" data-verso-hover="32">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.423" data-verso-hover="58">j</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="unknown token" data-binding="">∑</span> <span class="var token" data-binding="var-_uniq.433" data-verso-hover="123">a</span> <span class="var token" data-binding="var-_uniq.782" data-verso-hover="123">b</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.394" data-verso-hover="125">w</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.433" data-verso-hover="123">a</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.782" data-verso-hover="123">b</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.410" data-verso-hover="59">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.421" data-verso-hover="32">i</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Fin.shift" data-verso-hover="115">shift</span> <span class="var token" data-binding="var-_uniq.433" data-verso-hover="123">a</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.423" data-verso-hover="58">j</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Fin.shift" data-verso-hover="115">shift</span> <span class="var token" data-binding="var-_uniq.782" data-verso-hover="123">b</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><p>
              In practice, a convolutional layer takes as input a stack of images <code>x</code>, a stack of kernels <code>w</code>, and a bias <code>b</code>. Let's index images by an arbitrary type <code>I</code> and kernels by <code>J×I</code>:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-10711" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-10724">def</span> <span class="const token" data-binding="const-conv2d" data-verso-hover="126">conv2d</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span> <span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Nat" data-verso-hover="5">Nat</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.6" data-verso-hover="4">k</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Nat" data-verso-hover="5">Nat</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.8" data-verso-hover="39">J</span> <span class="unknown token" data-binding="">:</span> <span class="sort token" data-binding="">Type</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.10" data-verso-hover="39">I</span> <span class="unknown token" data-binding="">:</span> <span class="sort token" data-binding="">Type</span><span class="unknown token" data-binding="">}</span>
    <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-SciLean.IndexType" data-verso-hover="41">IndexType</span> <span class="var token" data-binding="var-_uniq.10" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-SciLean.IndexType" data-verso-hover="41">IndexType</span> <span class="var token" data-binding="var-_uniq.8" data-verso-hover="39">J</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-DecidableEq" data-verso-hover="74">DecidableEq</span> <span class="var token" data-binding="var-_uniq.8" data-verso-hover="39">J</span><span class="unknown token" data-binding="">]</span>
    <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.430" data-verso-hover="127">w</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.8" data-verso-hover="39">J</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.10" data-verso-hover="39">I</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">-</span><span class="var token" data-binding="var-_uniq.6" data-verso-hover="4">k</span><span class="unknown token" data-binding="">:</span><span class="var token" data-binding="var-_uniq.6" data-verso-hover="4">k</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">-</span><span class="var token" data-binding="var-_uniq.6" data-verso-hover="4">k</span><span class="unknown token" data-binding="">:</span><span class="var token" data-binding="var-_uniq.6" data-verso-hover="4">k</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.454" data-verso-hover="128">b</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.8" data-verso-hover="39">J</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.477" data-verso-hover="129">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.10" data-verso-hover="39">I</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span>
    <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.8" data-verso-hover="39">J</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">:=</span>
  <span class="unknown token" data-binding="">⊞</span> <span class="var token" data-binding="var-_uniq.501" data-verso-hover="130">κ</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.503" data-verso-hover="32">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.505" data-verso-hover="58">j</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.4" data-verso-hover="4">m</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span>
    <span class="var token" data-binding="var-_uniq.454" data-verso-hover="128">b</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.501" data-verso-hover="130">κ</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.503" data-verso-hover="32">i</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.505" data-verso-hover="58">j</span><span class="unknown token" data-binding="">]</span>
    <span class="unknown token" data-binding="">+</span>
    <span class="unknown token" data-binding="">∑</span> <span class="var token" data-binding="var-_uniq.559" data-verso-hover="86">ι</span> <span class="var token" data-binding="var-_uniq.907" data-verso-hover="123">a</span> <span class="var token" data-binding="var-_uniq.1255" data-verso-hover="123">b</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.430" data-verso-hover="127">w</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.501" data-verso-hover="130">κ</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.559" data-verso-hover="86">ι</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.907" data-verso-hover="123">a</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.1255" data-verso-hover="123">b</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.477" data-verso-hover="129">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.559" data-verso-hover="86">ι</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.503" data-verso-hover="32">i</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Fin.shift" data-verso-hover="115">shift</span> <span class="var token" data-binding="var-_uniq.907" data-verso-hover="123">a</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.505" data-verso-hover="58">j</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Fin.shift" data-verso-hover="115">shift</span> <span class="var token" data-binding="var-_uniq.1255" data-verso-hover="123">b</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><section>
              <h3 id="Scientific-Computing-in-Lean--Working-with-Arrays--Tensor-Operations--Convolution-and-Operations-on-Indices--Exercises">
                Exercises</h3>
              <ol start="1">
                <li>
                  <p>
                    Generalize the function <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-Fin.shift" data-verso-hover="115">Fin.shift</span></code>. Mathlib usues notation <code>x+ᵥy</code> for "shifting" <code>(y : Y)</code> by <code>(x : X)</code>. This operation is provided by the typeclass <code>VAdd X Y</code>. Define instance <code>VAdd ℤ (Fin n)</code> for adding an integer <code>(j : ℤ)</code> to number <code>(i : Fin n)</code> that wraps around on overflow or underlow. Feel free to use <code>sorry</code> for proving that the result is indeed in <code>Fin n</code>. Further define <code>VAdd (Set.Icc a b) (Fin n)</code> for <code>(a b : ℤ)</code> and <code>VAdd J I → VAdd J' I' → VAdd (J×J') (I×I')</code>.</p>
                  </li>
                </ol>
              <div class="collapsible" onclick="this.classList.toggle('expanded');">
                <div class="collapsible-header">
                  Solution</div>
                <div class="collapsible-content">
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-11584" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-11597">instance</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span> <span class="unknown token" data-binding="">:</span> <span class="unknown token" data-binding="">ℕ</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-VAdd" data-verso-hover="131">VAdd</span> <span class="unknown token" data-binding="">ℤ</span> <span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span> 
  <span class="unknown token" data-binding="">⟨</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-11644">fun</span> <span class="var token" data-binding="var-_uniq.19" data-verso-hover="116">j</span> <span class="var token" data-binding="var-_uniq.22" data-verso-hover="32">i</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="unknown token" data-binding="">⟨</span><span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Int.ofNat" data-verso-hover="118">Int.ofNat</span> <span class="var token" data-binding="var-_uniq.22" data-verso-hover="32">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span> <span class="unknown token" data-binding="">+</span> <span class="var token" data-binding="var-_uniq.19" data-verso-hover="116">j</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">%</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">.</span><span class="const token" data-binding="const-Int.toNat" data-verso-hover="119">toNat</span><span class="unknown token" data-binding="">,</span> <span class="keyword token" data-binding="kw-occ-SciLean.termSorry_proof-11689" data-verso-hover="67">sorry_proof</span><span class="unknown token" data-binding="">⟩</span><span class="unknown token" data-binding="">⟩</span>

<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-11708">instance</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.206" data-verso-hover="116">a</span> <span class="var token" data-binding="var-_uniq.208" data-verso-hover="116">b</span> <span class="unknown token" data-binding="">:</span> <span class="unknown token" data-binding="">ℤ</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.210" data-verso-hover="4">n</span> <span class="unknown token" data-binding="">:</span> <span class="unknown token" data-binding="">ℕ</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-VAdd" data-verso-hover="131">VAdd</span> <span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> <span class="var token" data-binding="var-_uniq.206" data-verso-hover="116">a</span> <span class="var token" data-binding="var-_uniq.208" data-verso-hover="116">b</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.210" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span> 
  <span class="unknown token" data-binding="">⟨</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-11777">fun</span> <span class="var token" data-binding="var-_uniq.513" data-verso-hover="133">j</span> <span class="var token" data-binding="var-_uniq.516" data-verso-hover="32">i</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="var token" data-binding="var-_uniq.513" data-verso-hover="133">j</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span> <span class="unknown token" data-binding="">+ᵥ</span> <span class="var token" data-binding="var-_uniq.516" data-verso-hover="32">i</span><span class="unknown token" data-binding="">⟩</span>

<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-11803" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.instance-11816">instance</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.587" data-verso-hover="134">I</span> <span class="var token" data-binding="var-_uniq.590" data-verso-hover="135">I'</span> <span class="var token" data-binding="var-_uniq.593" data-verso-hover="136">J</span> <span class="var token" data-binding="var-_uniq.596" data-verso-hover="137">J'</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-VAdd" data-verso-hover="131">VAdd</span> <span class="var token" data-binding="var-_uniq.593" data-verso-hover="136">J</span> <span class="var token" data-binding="var-_uniq.587" data-verso-hover="134">I</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-VAdd" data-verso-hover="131">VAdd</span> <span class="var token" data-binding="var-_uniq.596" data-verso-hover="137">J'</span> <span class="var token" data-binding="var-_uniq.590" data-verso-hover="135">I'</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-VAdd" data-verso-hover="131">VAdd</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.593" data-verso-hover="136">J</span><span class="unknown token" data-binding="">×</span><span class="var token" data-binding="var-_uniq.596" data-verso-hover="137">J'</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.587" data-verso-hover="134">I</span><span class="unknown token" data-binding="">×</span><span class="var token" data-binding="var-_uniq.590" data-verso-hover="135">I'</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span> 
  <span class="unknown token" data-binding="">⟨</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-11893">fun</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.658" data-verso-hover="130">j</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.659" data-verso-hover="138">j'</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.684" data-verso-hover="86">i</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.685" data-verso-hover="139">i'</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.658" data-verso-hover="130">j</span><span class="unknown token" data-binding="">+ᵥ</span><span class="var token" data-binding="var-_uniq.684" data-verso-hover="86">i</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.659" data-verso-hover="138">j'</span><span class="unknown token" data-binding="">+ᵥ</span><span class="var token" data-binding="var-_uniq.685" data-verso-hover="139">i'</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">⟩</span>
<span class="unknown token" data-binding=""></span></code></div>
                </div>
              <ol start="2">
                <li>
                  <p>
                    Implement General convolution for arbitrary rank tensors</p>
                  </li>
                </ol>
              <div class="collapsible" onclick="this.classList.toggle('expanded');">
                <div class="collapsible-header">
                  Solution</div>
                <div class="collapsible-content">
                  <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-12027" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-12040">def</span> <span class="const token" data-binding="const-convNd" data-verso-hover="140">convNd</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">J</span> <span class="unknown token" data-binding="">:</span> <span class="sort token" data-binding="">Type</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-SciLean.IndexType" data-verso-hover="41">IndexType</span> <span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">J</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.7" data-verso-hover="39">I</span> <span class="unknown token" data-binding="">:</span> <span class="sort token" data-binding="">Type</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-SciLean.IndexType" data-verso-hover="41">IndexType</span> <span class="var token" data-binding="var-_uniq.7" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-VAdd" data-verso-hover="131">VAdd</span> <span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">J</span> <span class="var token" data-binding="var-_uniq.7" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span>
    <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.22" data-verso-hover="141">w</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.2" data-verso-hover="39">J</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.27" data-verso-hover="84">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.7" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.7" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">:=</span> 
  <span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.40" data-verso-hover="86">i</span> <span class="unknown token" data-binding="">:</span> <span class="var token" data-binding="var-_uniq.7" data-verso-hover="39">I</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="unknown token" data-binding="">∑</span> <span class="var token" data-binding="var-_uniq.50" data-verso-hover="130">j</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.22" data-verso-hover="141">w</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.50" data-verso-hover="130">j</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.27" data-verso-hover="84">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.50" data-verso-hover="130">j</span> <span class="unknown token" data-binding="">+ᵥ</span> <span class="var token" data-binding="var-_uniq.40" data-verso-hover="86">i</span><span class="unknown token" data-binding="">]</span>

<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.variable-12208" data-verso-hover="52">variable</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.889" data-verso-hover="142">w</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">-</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">:</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">-</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">:</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">[</span><span class="unknown token" data-binding="">-</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">:</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.924" data-verso-hover="143">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="unknown token" data-binding="">10</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">10</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">10</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span>

<span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">convNd w x : Float^[10, 10, 10]</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.check-12276">#check</span></span> <span class="const token" data-binding="const-convNd" data-verso-hover="144">convNd</span> <span class="var token" data-binding="var-_uniq.889" data-verso-hover="142">w</span> <span class="var token" data-binding="var-_uniq.924" data-verso-hover="143">x</span>

-- #eval convNd (⊞ (i j k : Set.Icc (-1) 1) =&gt; 1.0/(1.0 + |Float.ofInt i.1| + |Float.ofInt j.1| + |Float.ofInt k.1|))
--               (⊞ (i j k : Fin 5) =&gt; if i.1 = j.1 ∧ j.1 = k.1 then 1.0 else 0.0)
<span class="unknown token" data-binding=""></span></code></div>
                </div>
              <ol start="3">
                <li>
                  <p>
                    Generalize the above to a proper general convolution layer which accepts stack of filters, images and biases. Similarly to what we have done to  <code class="hl lean inline" data-lean-context="examples"><span class="const token" data-binding="const-conv2d" data-verso-hover="145">conv2d</span></code> previously.</p>
                  </li>
                </ol>
              </section>
            </section>
          <section>
            <h2 id="Scientific-Computing-in-Lean--Working-with-Arrays--Tensor-Operations--Pooling-and-Difficulties-with-Dependent-Types">
              Pooling and Difficulties with Dependent Types</h2>
            <p>
              The next piece of neural networks is the pooling layer, a layer that reduces image resolution. Giving a good type to the pooling layer is quite challenging, as we have to divide the image resolution by two. Doing any kinds of operations in types brings out all the complexities of dependent type theory. Yes, dependent types can be really hard, but please do not get discouraged by this section. One has to be careful and not put dependent types everywhere, but when used with care, they can provide lots of benefits without causing too many troubles.</p>
            <p>
              The canonical example is if you have an index <code>i : Fin (n + m)</code> and you have a function <code>f : Fin (m + n) → Float</code>, you can't simply call <code>f i</code> as <code>Fin (n + m)</code> is not <strong>obviously</strong> equal to <code>Fin (m + n)</code> because we need to invoke commutativity of addition on natural numbers. We will explain how to deal with this later; for now, let's have a look at the pooling layer.</p>
            <p>
              Let's start with one dimension. A function that reduces the array size by two by taking the average of <code>x[2*i]</code> and <code>x[2*i+1]</code> is:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-13816">def</span> <span class="const token" data-binding="const-avgPool" data-verso-hover="146">avgPool</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.627" data-verso-hover="31">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.621" data-verso-hover="4">n</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.621" data-verso-hover="4">n</span><span class="unknown token" data-binding="">/</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">:=</span>
  <span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.772" data-verso-hover="147">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span><span class="unknown token" data-binding="">/</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">)</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span>
    <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.let-13890" data-verso-hover="78">let</span> <span class="var token" data-binding="var-_uniq.858" data-verso-hover="32">i₁</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">⟨</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="var token" data-binding="var-_uniq.772" data-verso-hover="147">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">,</span> <span class="tactic"><label for="tactic-state-13636902689723266745-13920-13922"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.byTactic-13920" data-verso-hover="69">by</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-13636902689723266745-13920-13922"><div class="tactic-state"><div class="goal"><table class="hypotheses"><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.582" data-verso-hover="142">w</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1)]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.617" data-verso-hover="143">x✝</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10, 10, 10]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Nat" data-verso-hover="5">ℕ</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.627" data-verso-hover="31">x</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[<span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span>]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.772" data-verso-hover="147">i</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> (<span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span><span class="const token" data-binding="const-HDiv.hDiv" data-verso-hover="148"> / </span>2)</td></tr></table><span class="conclusion"><span class="prefix">⊢ </span><span class="type">2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span>↑<span class="var token" data-binding="var-_uniq.772" data-verso-hover="147">i</span><span class="const token" data-binding="const-LT.lt" data-verso-hover="150"> &lt; </span><span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span></span></span></div></div></span> <span class="tactic"><label for="tactic-state-7-13923-13928"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Tactic.omega-13923" data-verso-hover="151">omega</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-7-13923-13928"><div class="tactic-state">All goals completed! 🐙</div></span><span class="unknown token" data-binding="">⟩</span>
    <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.let-13936" data-verso-hover="78">let</span> <span class="var token" data-binding="var-_uniq.991" data-verso-hover="32">i₂</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">⟨</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="var token" data-binding="var-_uniq.772" data-verso-hover="147">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">+</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">,</span> <span class="tactic"><label for="tactic-state-10148925498667782627-13968-13970"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.byTactic-13968" data-verso-hover="69">by</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-10148925498667782627-13968-13970"><div class="tactic-state"><div class="goal"><table class="hypotheses"><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.582" data-verso-hover="142">w</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1)]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.617" data-verso-hover="143">x✝</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10, 10, 10]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Nat" data-verso-hover="5">ℕ</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.627" data-verso-hover="31">x</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[<span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span>]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.772" data-verso-hover="147">i</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> (<span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span><span class="const token" data-binding="const-HDiv.hDiv" data-verso-hover="148"> / </span>2)</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.858" data-verso-hover="32">i₁</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span> := ⟨2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span>↑<span class="var token" data-binding="var-_uniq.772" data-verso-hover="147">i</span>, ⋯⟩</td></tr></table><span class="conclusion"><span class="prefix">⊢ </span><span class="type">2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span>↑<span class="var token" data-binding="var-_uniq.772" data-verso-hover="147">i</span><span class="const token" data-binding="const-HAdd.hAdd" data-verso-hover="152"> + </span>1<span class="const token" data-binding="const-LT.lt" data-verso-hover="150"> &lt; </span><span class="var token" data-binding="var-_uniq.717" data-verso-hover="4">n</span></span></span></div></div></span> <span class="tactic"><label for="tactic-state-7-13971-13976"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Tactic.omega-13971" data-verso-hover="151">omega</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-7-13971-13976"><div class="tactic-state">All goals completed! 🐙</div></span><span class="unknown token" data-binding="">⟩</span>
    <span class="unknown token" data-binding="">0.5</span> <span class="unknown token" data-binding="">*</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.627" data-verso-hover="31">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.858" data-verso-hover="32">i₁</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">+</span> <span class="var token" data-binding="var-_uniq.627" data-verso-hover="31">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.991" data-verso-hover="32">i₂</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span>
<span class="unknown token" data-binding=""></span></code><p>
              Given the index of the new array <code>i : Fin (n/2)</code>, we need to produce indices <code>2*i.1</code> and <code>2*i.1+1</code> of the old vector, which have type <code>Fin n</code>. Recall that <code>Fin n</code> is just a pair of natural numbers and a proof that it is smaller than <code>n</code>. So far, we always omitted the proof with <code>sorry</code>, but we do not have to. Here, the proof can be easily done by calling the tactic <code>omega</code>, which is very good at proving index bounds. However, remember when you are writing a program, it is usually a good strategy to inspect all proofs, see if they are plausible, and omit them with <code>sorry</code>. Only once your program is capable of running, you can go back and start filling out the proofs. You can see this as an alternative way of debugging your program.</p>
            <p>
              Beware! <code>Fin n</code> is endowed with modular arithmetic. Naively calling <code>2*i</code> would multiply <code>i</code> by two and perform modulo by <code>n/2</code>. We do not want that; we have to get the underlying natural number <code>i.1</code> and multiply then by two. For example:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-15006">def</span> <span class="const token" data-binding="const-i" data-verso-hover="153">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="unknown token" data-binding="">10</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">6</span>
<span class="unknown token" data-binding=""></span></code><code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">2
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-15055">#eval</span></span> <span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="const token" data-binding="const-i" data-verso-hover="154">i</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>2
</pre></div>
            <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">12
</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.eval-15121">#eval</span></span> <span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="const token" data-binding="const-i" data-verso-hover="154">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>12
</pre></div>
            <p>
              One downside of the <code>avgPool</code> as written above is that if we call it multiple times, we get an array with an ugly type. For example, <code>avgPool (avgPool x)</code> has type <code>Float^[n/2/2]</code>. If we have a size that we already know is divisible by four, the <code>n/2/2</code> does not reduce. For <code>x : Float^[4*n]</code>, the term <code>avgPool (avgPool x)</code> has type <code>Float^[4*n/2/2]</code> and not <code>Float^[n]</code>.</p>
            <p>
              You might attempt to solve this by writing the type of <code>avgPool</code> as:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-15633">def</span> <span class="const token" data-binding="const-avgPool" data-verso-hover="155">avgPool</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.727" data-verso-hover="156">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="var token" data-binding="var-_uniq.649" data-verso-hover="4">n</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.649" data-verso-hover="4">n</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">:=</span>
  <span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.740" data-verso-hover="32">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span>
    <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.let-15703" data-verso-hover="78">let</span> <span class="var token" data-binding="var-_uniq.845" data-verso-hover="157">i₁</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">⟨</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="var token" data-binding="var-_uniq.740" data-verso-hover="32">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">,</span> <span class="tactic"><label for="tactic-state-10495738519314454034-15737-15739"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.byTactic-15737" data-verso-hover="69">by</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-10495738519314454034-15737-15739"><div class="tactic-state"><div class="goal"><table class="hypotheses"><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.582" data-verso-hover="142">w</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1)]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.617" data-verso-hover="143">x✝</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10, 10, 10]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Nat" data-verso-hover="5">ℕ</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.727" data-verso-hover="156">x</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span><span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span>]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.740" data-verso-hover="32">i</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span></td></tr></table><span class="conclusion"><span class="prefix">⊢ </span><span class="type">2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span>↑<span class="var token" data-binding="var-_uniq.740" data-verso-hover="32">i</span><span class="const token" data-binding="const-LT.lt" data-verso-hover="150"> &lt; </span>2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span><span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span></span></span></div></div></span> <span class="tactic"><label for="tactic-state-7-15740-15745"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Tactic.omega-15740" data-verso-hover="151">omega</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-7-15740-15745"><div class="tactic-state">All goals completed! 🐙</div></span><span class="unknown token" data-binding="">⟩</span>
    <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.let-15753" data-verso-hover="78">let</span> <span class="var token" data-binding="var-_uniq.1026" data-verso-hover="157">i₂</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">⟨</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="var token" data-binding="var-_uniq.740" data-verso-hover="32">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">+</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">,</span> <span class="tactic"><label for="tactic-state-16157045488453658501-15789-15791"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.byTactic-15789" data-verso-hover="69">by</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-16157045488453658501-15789-15791"><div class="tactic-state"><div class="goal"><table class="hypotheses"><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.582" data-verso-hover="142">w</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1)]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.617" data-verso-hover="143">x✝</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10, 10, 10]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Nat" data-verso-hover="5">ℕ</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.727" data-verso-hover="156">x</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span><span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span>]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.740" data-verso-hover="32">i</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.845" data-verso-hover="157">i₁</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> (2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span><span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span>) := ⟨2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span>↑<span class="var token" data-binding="var-_uniq.740" data-verso-hover="32">i</span>, ⋯⟩</td></tr></table><span class="conclusion"><span class="prefix">⊢ </span><span class="type">2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span>↑<span class="var token" data-binding="var-_uniq.740" data-verso-hover="32">i</span><span class="const token" data-binding="const-HAdd.hAdd" data-verso-hover="152"> + </span>1<span class="const token" data-binding="const-LT.lt" data-verso-hover="150"> &lt; </span>2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span><span class="var token" data-binding="var-_uniq.737" data-verso-hover="4">n</span></span></span></div></div></span> <span class="tactic"><label for="tactic-state-7-15792-15797"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Tactic.omega-15792" data-verso-hover="151">omega</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-7-15792-15797"><div class="tactic-state">All goals completed! 🐙</div></span><span class="unknown token" data-binding="">⟩</span>
    <span class="unknown token" data-binding="">0.5</span> <span class="unknown token" data-binding="">*</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.727" data-verso-hover="156">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.845" data-verso-hover="157">i₁</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">+</span> <span class="var token" data-binding="var-_uniq.727" data-verso-hover="156">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.1026" data-verso-hover="157">i₂</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span>
<span class="unknown token" data-binding=""></span></code><p>
              Unfortunately, this does not work. Lean's type checking is not smart enough to allow us to call <code>avgPool x</code> for <code>x : Float^[4*m]</code>. It can't figure out that <code>4*m = 2*(2*m)</code> and infer that <code>n = 2*m</code> when calling <code>avgPool</code>. We have to do something else.</p>
            <p>
              The most flexible way of writing the <code>avgPool</code> function is as follows:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-16169">def</span> <span class="const token" data-binding="const-avgPool" data-verso-hover="158">avgPool</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.627" data-verso-hover="31">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.621" data-verso-hover="4">n</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.630" data-verso-hover="4">m</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.718" data-verso-hover="159">h</span> <span class="unknown token" data-binding="">:</span> <span class="var token" data-binding="var-_uniq.630" data-verso-hover="4">m</span> <span class="unknown token" data-binding="">=</span> <span class="var token" data-binding="var-_uniq.621" data-verso-hover="4">n</span><span class="unknown token" data-binding="">/</span><span class="unknown token" data-binding="">2</span> <span class="unknown token" data-binding="">:=</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.binderTactic-16214">by</span> <span class="keyword token" data-binding="kw-occ-SciLean.inferVar-16220">infer_var</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.630" data-verso-hover="4">m</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">:=</span>
  <span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.730" data-verso-hover="58">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.630" data-verso-hover="4">m</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span>
    <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.let-16271" data-verso-hover="78">let</span> <span class="var token" data-binding="var-_uniq.811" data-verso-hover="32">i1</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">⟨</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="var token" data-binding="var-_uniq.730" data-verso-hover="58">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">,</span> <span class="tactic"><label for="tactic-state-14218636660967227320-16299-16301"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.byTactic-16299" data-verso-hover="69">by</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-14218636660967227320-16299-16301"><div class="tactic-state"><div class="goal"><table class="hypotheses"><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.582" data-verso-hover="142">w</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1)]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.617" data-verso-hover="143">x✝</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10, 10, 10]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Nat" data-verso-hover="5">ℕ</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.627" data-verso-hover="31">x</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[<span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span>]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.630" data-verso-hover="4">m</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Nat" data-verso-hover="5">ℕ</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.718" data-verso-hover="159">h</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-autoParam" data-verso-hover="160">autoParam</span> (<span class="var token" data-binding="var-_uniq.630" data-verso-hover="4">m</span><span class="const token" data-binding="const-Eq" data-verso-hover="71"> = </span><span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span><span class="const token" data-binding="const-HDiv.hDiv" data-verso-hover="148"> / </span>2) <span class="const token" data-binding="const-_auto._@.ScientificComputingInLean.WorkingWithArrays.TensorOperations._hyg.64" data-verso-hover="161">_auto✝</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.730" data-verso-hover="58">i</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.630" data-verso-hover="4">m</span></td></tr></table><span class="conclusion"><span class="prefix">⊢ </span><span class="type">2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span>↑<span class="var token" data-binding="var-_uniq.730" data-verso-hover="58">i</span><span class="const token" data-binding="const-LT.lt" data-verso-hover="150"> &lt; </span><span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span></span></span></div></div></span> <span class="tactic"><label for="tactic-state-7-16302-16307"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Tactic.omega-16302" data-verso-hover="151">omega</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-7-16302-16307"><div class="tactic-state">All goals completed! 🐙</div></span><span class="unknown token" data-binding="">⟩</span>
    <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.let-16315" data-verso-hover="78">let</span> <span class="var token" data-binding="var-_uniq.944" data-verso-hover="32">i2</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">⟨</span><span class="unknown token" data-binding="">2</span><span class="unknown token" data-binding="">*</span><span class="var token" data-binding="var-_uniq.730" data-verso-hover="58">i</span><span class="unknown token" data-binding="">.</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">+</span><span class="unknown token" data-binding="">1</span><span class="unknown token" data-binding="">,</span> <span class="tactic"><label for="tactic-state-2375195918828463360-16345-16347"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.byTactic-16345" data-verso-hover="69">by</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-2375195918828463360-16345-16347"><div class="tactic-state"><div class="goal"><table class="hypotheses"><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.582" data-verso-hover="142">w</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1)]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.617" data-verso-hover="143">x✝</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10, 10, 10]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Nat" data-verso-hover="5">ℕ</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.627" data-verso-hover="31">x</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[<span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span>]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.630" data-verso-hover="4">m</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Nat" data-verso-hover="5">ℕ</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.718" data-verso-hover="159">h</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-autoParam" data-verso-hover="160">autoParam</span> (<span class="var token" data-binding="var-_uniq.630" data-verso-hover="4">m</span><span class="const token" data-binding="const-Eq" data-verso-hover="71"> = </span><span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span><span class="const token" data-binding="const-HDiv.hDiv" data-verso-hover="148"> / </span>2) <span class="const token" data-binding="const-_auto._@.ScientificComputingInLean.WorkingWithArrays.TensorOperations._hyg.64" data-verso-hover="161">_auto✝</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.730" data-verso-hover="58">i</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.630" data-verso-hover="4">m</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.811" data-verso-hover="32">i1</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span> := ⟨2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span>↑<span class="var token" data-binding="var-_uniq.730" data-verso-hover="58">i</span>, ⋯⟩</td></tr></table><span class="conclusion"><span class="prefix">⊢ </span><span class="type">2<span class="const token" data-binding="const-HMul.hMul" data-verso-hover="149"> * </span>↑<span class="var token" data-binding="var-_uniq.730" data-verso-hover="58">i</span><span class="const token" data-binding="const-HAdd.hAdd" data-verso-hover="152"> + </span>1<span class="const token" data-binding="const-LT.lt" data-verso-hover="150"> &lt; </span><span class="var token" data-binding="var-_uniq.725" data-verso-hover="4">n</span></span></span></div></div></span> <span class="tactic"><label for="tactic-state-7-16348-16353"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Tactic.omega-16348" data-verso-hover="151">omega</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-7-16348-16353"><div class="tactic-state">All goals completed! 🐙</div></span><span class="unknown token" data-binding="">⟩</span>
    <span class="unknown token" data-binding="">0.5</span> <span class="unknown token" data-binding="">*</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.627" data-verso-hover="31">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.811" data-verso-hover="32">i1</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">+</span> <span class="var token" data-binding="var-_uniq.627" data-verso-hover="31">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.944" data-verso-hover="32">i2</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span>
<span class="unknown token" data-binding=""></span></code><p>
              Here, the output dimension <code>m</code> is implicitly inferred from the proof <code>h : m = n/2</code>. Let's go step by step on what is going on.</p>
            <p>
              When you call <code>avgPool x</code> for <code>x : Float^[4*k]</code>, the first argument is expected to have type <code>Float^[n]</code>. From this, Lean infers that <code>n = 4*k</code>. The next argument <code>{m}</code> is implicit, so Lean skips it for now as it is supposed to be inferred from the following arguments. Lastly, we have the argument <code>h : m = n/2</code>, which has the default value <code>by infer_var</code>. The tactic <code>infer_var</code> expects an expression with an undetermined variable, in our case <code>m</code>, and runs normalization on <code>n/2</code> and assigns the result to <code>m</code>. In this case, <code>4*k/2</code> gets simplified to <code>2*k</code>, and that is the final value of <code>m</code>.</p>
            <p>
              You might be wondering what happens when <code>n</code> is odd. Because <code>n/2</code> performs natural division, for <code>x : Float^[2*n+1]</code>, calling <code>avgPool x</code> produces an array of type <code>Float^[n]</code>. If you want to prevent calling <code>avgPool</code> on arrays of odd length, you can simply modify the proof obligation to <code>(h : 2*m = n)</code>. This way, you require that <code>n</code> is even, and calling <code>avgPool x</code> with an odd-sized array <code>x</code> will produce an error.</p>
            <p>
              To build a simple neural network, we need a two-dimensional version of the pooling layer:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-17637" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.variable-17650" data-verso-hover="52">variable</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.619" data-verso-hover="4">n₁</span> <span class="var token" data-binding="var-_uniq.621" data-verso-hover="4">n₂</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Nat" data-verso-hover="5">Nat</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.623" data-verso-hover="39">I</span> <span class="unknown token" data-binding="">:</span> <span class="sort token" data-binding="">Type</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-SciLean.IndexType" data-verso-hover="41">IndexType</span> <span class="var token" data-binding="var-_uniq.623" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-DecidableEq" data-verso-hover="74">DecidableEq</span> <span class="var token" data-binding="var-_uniq.623" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-17718">def</span> <span class="const token" data-binding="const-avgPool2d" data-verso-hover="162">avgPool2d</span>
    <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1295" data-verso-hover="163">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.623" data-verso-hover="39">I</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.619" data-verso-hover="4">n₁</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.621" data-verso-hover="4">n₂</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.1297" data-verso-hover="4">m₁</span> <span class="var token" data-binding="var-_uniq.1299" data-verso-hover="4">m₂</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Nat" data-verso-hover="5">Nat</span><span class="unknown token" data-binding="">}</span>
    <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1387" data-verso-hover="164">h₁</span> <span class="unknown token" data-binding="">:</span> <span class="var token" data-binding="var-_uniq.1297" data-verso-hover="4">m₁</span> <span class="unknown token" data-binding="">=</span> <span class="var token" data-binding="var-_uniq.619" data-verso-hover="4">n₁</span><span class="unknown token" data-binding="">/</span><span class="unknown token" data-binding="">2</span> <span class="unknown token" data-binding="">:=</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.binderTactic-17806">by</span> <span class="keyword token" data-binding="kw-occ-SciLean.inferVar-17812">infer_var</span><span class="unknown token" data-binding="">)</span>
    <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1444" data-verso-hover="165">h₂</span> <span class="unknown token" data-binding="">:</span> <span class="var token" data-binding="var-_uniq.1299" data-verso-hover="4">m₂</span> <span class="unknown token" data-binding="">=</span> <span class="var token" data-binding="var-_uniq.621" data-verso-hover="4">n₂</span><span class="unknown token" data-binding="">/</span><span class="unknown token" data-binding="">2</span> <span class="unknown token" data-binding="">:=</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.binderTactic-17849">by</span> <span class="keyword token" data-binding="kw-occ-SciLean.inferVar-17855">infer_var</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.623" data-verso-hover="39">I</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.1297" data-verso-hover="4">m₁</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.1299" data-verso-hover="4">m₂</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">:=</span>
  <span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1474" data-verso-hover="86">ι</span> <span class="unknown token" data-binding="">:</span> <span class="var token" data-binding="var-_uniq.623" data-verso-hover="39">I</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1476" data-verso-hover="166">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.1297" data-verso-hover="4">m₁</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1478" data-verso-hover="167">j</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.1299" data-verso-hover="4">m₂</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="unknown token" data-binding="">0.0</span>
    -- let i₁ : Fin n₁ := ⟨2*i.1, by omega⟩
    -- let i₂ : Fin n₁ := ⟨2*i.1+1, by omega⟩
    -- let j₁ : Fin n₂ := ⟨2*j.1, by omega⟩
    -- let j₂ : Fin n₂ := ⟨2*j.1+1, by omega⟩
    -- 0.0
<span class="unknown token" data-binding=""></span></code></section>
          <section>
            <h2 id="Scientific-Computing-in-Lean--Working-with-Arrays--Tensor-Operations--Simple-Neural-Network">
              Simple Neural Network</h2>
            <p>
              We are almost ready to write a simple neural network. The only missing piece is the dense layer, which is just matrix multiplication followed by addition. We have already shown matrix multiplication previously, but it was only for multiplying by a normal matrix with <code>n</code> rows and <code>m</code> columns. A general dense layer takes a tensor <code>x</code> of any shape, treats it as a flat array of <code>m</code> elements, and multiplies that by an <code>n×m</code> matrix. Because our arrays allow indexing by an arbitrary type <code>I</code>, we do not need to perform this flattening explicitly and can just multiply by the matrix <code>Float^[n,I]</code>.</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.open-18801" data-verso-hover="13">open</span> <span class="unknown token" data-binding="">SciLean</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.variable-18814" data-verso-hover="52">variable</span> <span class="unknown token" data-binding="">{</span><span class="var token" data-binding="var-_uniq.637" data-verso-hover="39">I</span> <span class="unknown token" data-binding="">:</span> <span class="sort token" data-binding="">Type</span><span class="unknown token" data-binding="">}</span> <span class="unknown token" data-binding="">[</span><span class="const token" data-binding="const-SciLean.IndexType" data-verso-hover="41">IndexType</span> <span class="var token" data-binding="var-_uniq.637" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span>
<span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-18848">def</span> <span class="const token" data-binding="const-dense" data-verso-hover="168">dense</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1282" data-verso-hover="4">n</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Nat" data-verso-hover="5">Nat</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1298" data-verso-hover="88">A</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.1282" data-verso-hover="4">n</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.637" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1304" data-verso-hover="31">b</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.1282" data-verso-hover="4">n</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1309" data-verso-hover="84">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.637" data-verso-hover="39">I</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="var token" data-binding="var-_uniq.1282" data-verso-hover="4">n</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">:=</span>
  <span class="unknown token" data-binding="">⊞</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.1319" data-verso-hover="32">i</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="var token" data-binding="var-_uniq.1282" data-verso-hover="4">n</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="var token" data-binding="var-_uniq.1304" data-verso-hover="31">b</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.1319" data-verso-hover="32">i</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">+</span> <span class="unknown token" data-binding="">∑</span> <span class="var token" data-binding="var-_uniq.1363" data-verso-hover="86">j</span><span class="unknown token" data-binding="">,</span> <span class="var token" data-binding="var-_uniq.1298" data-verso-hover="88">A</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.1319" data-verso-hover="32">i</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.1363" data-verso-hover="86">j</span><span class="unknown token" data-binding="">]</span> <span class="unknown token" data-binding="">*</span> <span class="var token" data-binding="var-_uniq.1309" data-verso-hover="84">x</span><span class="unknown token" data-binding="">[</span><span class="var token" data-binding="var-_uniq.1363" data-verso-hover="86">j</span><span class="unknown token" data-binding="">]</span>
<span class="unknown token" data-binding=""></span></code><p>
              Finally, we have all the necessary pieces, and we can implement a simple neural network.</p>
            <code class="hl lean block" data-lean-context="examples"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.definition-19085">def</span> <span class="const token" data-binding="const-nnet" data-verso-hover="169">nnet</span> <span class="unknown token" data-binding="">:=</span> <span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19097">fun</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.786" data-verso-hover="170">w₁</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.787" data-verso-hover="171">b₁</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.788" data-verso-hover="172">w₂</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.789" data-verso-hover="173">b₂</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.790" data-verso-hover="174">w₃</span><span class="unknown token" data-binding="">,</span><span class="var token" data-binding="var-_uniq.791" data-verso-hover="175">b₃</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="var token" data-binding="var-_uniq.670" data-verso-hover="176">x</span> <span class="unknown token" data-binding="">:</span> <span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span><span class="unknown token" data-binding="">^[</span><span class="unknown token" data-binding="">28</span><span class="unknown token" data-binding="">,</span><span class="unknown token" data-binding="">28</span><span class="unknown token" data-binding="">]</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">=&gt;</span>
  <span class="var token" data-binding="var-_uniq.670" data-verso-hover="176">x</span> <span class="unknown token" data-binding="">|&gt;.</span><span class="const token" data-binding="const-SciLean.DataArrayN.reshape" data-verso-hover="68">reshape</span> <span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="unknown token" data-binding="">1</span> <span class="unknown token" data-binding="">×</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="unknown token" data-binding="">28</span> <span class="unknown token" data-binding="">×</span> <span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="unknown token" data-binding="">28</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="tactic"><label for="tactic-state-3924699433632317672-19200-19202"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.byTactic-19200" data-verso-hover="69">by</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-3924699433632317672-19200-19202"><div class="tactic-state"><div class="goal"><table class="hypotheses"><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.582" data-verso-hover="142">w</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (-1) 1)]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.617" data-verso-hover="143">x✝¹</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10, 10, 10]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.619" data-verso-hover="4">n₁</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Nat" data-verso-hover="5">ℕ</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.621" data-verso-hover="4">n₂</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Nat" data-verso-hover="5">ℕ</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.623" data-verso-hover="39">I✝</span></td><td class="colon">:</td><td class="type"><span class="sort token" data-binding="">Type</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.626" data-verso-hover="177">inst✝²</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-SciLean.IndexType" data-verso-hover="41">IndexType</span> <span class="var token" data-binding="var-_uniq.623" data-verso-hover="39">I✝</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.633" data-verso-hover="178">inst✝¹</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-DecidableEq" data-verso-hover="74">DecidableEq</span> <span class="var token" data-binding="var-_uniq.623" data-verso-hover="39">I✝</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.637" data-verso-hover="39">I</span></td><td class="colon">:</td><td class="type"><span class="sort token" data-binding="">Type</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.640" data-verso-hover="179">inst✝</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-SciLean.IndexType" data-verso-hover="41">IndexType</span> <span class="var token" data-binding="var-_uniq.637" data-verso-hover="39">I</span></td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.646" data-verso-hover="180">x✝</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[8, 1, ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (<span class="const token" data-binding="const-Neg.neg" data-verso-hover="181">-</span>↑1) ↑1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (<span class="const token" data-binding="const-Neg.neg" data-verso-hover="181">-</span>↑1) ↑1)]<span class="const token" data-binding="const-Prod" data-verso-hover="70"> ×
  </span><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[8, 28, 28]<span class="const token" data-binding="const-Prod" data-verso-hover="70"> × </span><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[30, 8, 14, 14]<span class="const token" data-binding="const-Prod" data-verso-hover="70"> × </span><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[30]<span class="const token" data-binding="const-Prod" data-verso-hover="70"> × </span><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10, 30]<span class="const token" data-binding="const-Prod" data-verso-hover="70"> × </span><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.670" data-verso-hover="176">x</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[28, 28]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.786" data-verso-hover="170">w₁</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[8, 1, ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (<span class="const token" data-binding="const-Neg.neg" data-verso-hover="181">-</span>↑1) ↑1), ↑(<span class="const token" data-binding="const-Set.Icc" data-verso-hover="132">Set.Icc</span> (<span class="const token" data-binding="const-Neg.neg" data-verso-hover="181">-</span>↑1) ↑1)]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.787" data-verso-hover="171">b₁</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[8, 28, 28]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.788" data-verso-hover="172">w₂</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[30, 8, 14, 14]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.789" data-verso-hover="173">b₂</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[30]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.790" data-verso-hover="174">w₃</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10, 30]</td></tr><tr class="hypothesis"><td class="name"><span class="var token" data-binding="var-_uniq.791" data-verso-hover="175">b₃</span></td><td class="colon">:</td><td class="type"><span class="const token" data-binding="const-Float" data-verso-hover="27">Float</span>^[10]</td></tr></table><span class="conclusion"><span class="prefix">⊢ </span><span class="type"><span class="const token" data-binding="const-SciLean.Size.size" data-verso-hover="44">size</span> (<span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> 1<span class="const token" data-binding="const-Prod" data-verso-hover="70"> × </span><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> 28<span class="const token" data-binding="const-Prod" data-verso-hover="70"> × </span><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> 28)<span class="const token" data-binding="const-Eq" data-verso-hover="71"> = </span><span class="const token" data-binding="const-SciLean.Size.size" data-verso-hover="44">size</span> (<span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> 28<span class="const token" data-binding="const-Prod" data-verso-hover="70"> × </span><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> 28)</span></span></div></div></span> <span class="tactic"><label for="tactic-state-7-19203-19209"><span class="keyword token" data-binding="kw-occ-Lean.Parser.Tactic.decide-19203" data-verso-hover="72">decide</span></label><input type="checkbox" class="tactic-toggle" id="tactic-state-7-19203-19209"><div class="tactic-state">All goals completed! 🐙</div></span><span class="unknown token" data-binding="">)</span>
    <span class="unknown token" data-binding="">|&gt;</span> <span class="const token" data-binding="const-conv2d" data-verso-hover="145">conv2d</span> <span class="unknown token" data-binding="">1</span> <span class="unknown token" data-binding="">(</span><span class="const token" data-binding="const-Fin" data-verso-hover="54">Fin</span> <span class="unknown token" data-binding="">8</span><span class="unknown token" data-binding="">)</span> <span class="var token" data-binding="var-_uniq.786" data-verso-hover="170">w₁</span> <span class="var token" data-binding="var-_uniq.787" data-verso-hover="171">b₁</span>
    <span class="unknown token" data-binding="">|&gt;.</span><span class="const token" data-binding="const-SciLean.DataArrayN.mapMono" data-verso-hover="92">mapMono</span> <span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19261">fun</span> <span class="var token" data-binding="var-_uniq.990" data-verso-hover="79">x</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="const token" data-binding="const-Max.max" data-verso-hover="102">max</span> <span class="var token" data-binding="var-_uniq.990" data-verso-hover="79">x</span> <span class="unknown token" data-binding="">0</span><span class="unknown token" data-binding="">)</span>
    <span class="unknown token" data-binding="">|&gt;</span> <span class="const token" data-binding="const-avgPool2d" data-verso-hover="182">avgPool2d</span> <span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">m₁</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">14</span><span class="unknown token" data-binding="">)</span> <span class="unknown token" data-binding="">(</span><span class="unknown token" data-binding="">m₂</span> <span class="unknown token" data-binding="">:=</span> <span class="unknown token" data-binding="">14</span><span class="unknown token" data-binding="">)</span>
    <span class="unknown token" data-binding="">|&gt;</span> <span class="const token" data-binding="const-dense" data-verso-hover="183">dense</span> <span class="unknown token" data-binding="">30</span> <span class="var token" data-binding="var-_uniq.788" data-verso-hover="172">w₂</span> <span class="var token" data-binding="var-_uniq.789" data-verso-hover="173">b₂</span>
    <span class="unknown token" data-binding="">|&gt;.</span><span class="const token" data-binding="const-SciLean.DataArrayN.mapMono" data-verso-hover="92">mapMono</span> <span class="unknown token" data-binding="">(</span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Term.fun-19364">fun</span> <span class="var token" data-binding="var-_uniq.1078" data-verso-hover="79">x</span> <span class="unknown token" data-binding="">=&gt;</span> <span class="const token" data-binding="const-Max.max" data-verso-hover="102">max</span> <span class="var token" data-binding="var-_uniq.1078" data-verso-hover="79">x</span> <span class="unknown token" data-binding="">0</span><span class="unknown token" data-binding="">)</span>
    <span class="unknown token" data-binding="">|&gt;</span> <span class="const token" data-binding="const-dense" data-verso-hover="183">dense</span> <span class="unknown token" data-binding="">10</span> <span class="var token" data-binding="var-_uniq.790" data-verso-hover="174">w₃</span> <span class="var token" data-binding="var-_uniq.791" data-verso-hover="175">b₃</span>
    <span class="unknown token" data-binding="">|&gt;</span> <span class="const token" data-binding="const-softMax" data-verso-hover="184">softMax</span> <span class="unknown token" data-binding="">0.1</span>
<span class="unknown token" data-binding=""></span></code><p>
              When we check the type of <code>nnet</code>:</p>
            <code class="hl lean block" data-lean-context="examples"><span class="has-info info"><span class="hover-container"><span class="hover-info messages"><code class="message info">nnet :
  Float^[8, 1, ↑(Set.Icc (-↑1) ↑1), ↑(Set.Icc (-↑1) ↑1)] ×
      Float^[8, 28, 28] × Float^[30, 8, 14, 14] × Float^[30] × Float^[10, 30] × Float^[10] →
    Float^[28, 28] → Float^[10]</code></span></span><span class="keyword token" data-binding="kw-occ-Lean.Parser.Command.check-19492">#check</span></span> <span class="const token" data-binding="const-nnet" data-verso-hover="185">nnet</span>
<span class="unknown token" data-binding=""></span></code><div class="information">
              <pre>nnet :
  Float^[8, 1, ↑(Set.Icc (-↑1) ↑1), ↑(Set.Icc (-↑1) ↑1)] ×
      Float^[8, 28, 28] × Float^[30, 8, 14, 14] × Float^[30] × Float^[10, 30] × Float^[10] →
    Float^[28, 28] → Float^[10]
</pre></div>
            <p>
              You can see that the type of all the weights is automatically inferred.</p>
            <p>
              TODO: improve unexpander for <code>↑(Set.Icc (-↑1) ↑1)</code></p>
            <p>
              The input image has type <code>Float^[28,28]</code>, and the output is an array of ten elements <code>Float^[10]</code>. As you might have guessed from the dimensions, later in the book, we will train this network to classify handwritten digits from the MNIST database.
</p>
            </section>
          </section>
        </main></div>
    </body>
  </html>

