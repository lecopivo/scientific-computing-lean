<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Optimizing Array Expressions - Scientific Computing in Lean</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">
        <link rel="stylesheet" href="../pygments.css">
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../title.html">Scientific Computing in Lean</a></li><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">1.1.</strong> Sorry Friendly Programming</div></li><li class="chapter-item expanded "><a href="../installation.html"><strong aria-hidden="true">1.2.</strong> Setting Up Lean and SciLean</a></li></ol></li><li class="chapter-item expanded "><a href="../working-with-arrays.html"><strong aria-hidden="true">2.</strong> Working with Arrays</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../working-with-arrays/basics.html"><strong aria-hidden="true">2.1.</strong> Basic Operations</a></li><li class="chapter-item expanded "><a href="../working-with-arrays/tensor-operations.html"><strong aria-hidden="true">2.2.</strong> Tensor Operations</a></li><li class="chapter-item expanded "><a href="../working-with-arrays/optimizing-arrays.html" class="active"><strong aria-hidden="true">2.3.</strong> Optimizing Array Expressions</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.4.</strong> Abstract Array Interface</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Differentiation</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">3.1.</strong> Zoo of Differentiation Operators</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.</strong> Defining New Functions</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Theoretical Aspects*</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Function Transformations</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> Defining New Function Transformation</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> Function Transformation Algorithm*</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Problem Transformations</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Solve Function</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.</strong> Approximation</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Differential Equations</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Probabilistic Programming</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Scientific Computing in Lean</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/lecopivo/scientific-computing-lean" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="optimizing-array-expressions"><a class="header" href="#optimizing-array-expressions">Optimizing Array Expressions</a></h1>
<p>Lean is an interactive theorem prover. In this chapter, we will demonstrate how to use Lean as an interactive compiler or computer algebra system. We will focus on a common compiler optimization with arrays: loop fusion, which involves merging two loops into one. We will show how to craft such optimizations, explore them interactively, and discuss how to automate them.</p>
<p>Program optimization can be seen as rewriting a program into another program that is equivalent. By &quot;equivalent,&quot; we mean that for the same input, these programs produce the same output. There is a close parallel to theorem proving. Often, to prove equality <code>x = y</code>, we simplify <code>x</code> to <code>x'</code> and <code>y</code> to <code>y'</code>. If <code>x'</code> is identical to <code>y'</code>, we have proven that <code>x = y</code>. Lean provides a general-purpose expression simplifier called <code>simp</code>, which has a database of rewrite rules and tries to apply them to subexpressions.</p>
<p>For example, in Lean, there is a theorem stating that adding zero does not change the value:</p>
<pre><code class="language-lean">@[simp] theorem Nat.add_zero (n : Nat) : n + 0 = n := rfl
</code></pre>
<p>Adding the attribute <code>@[simp]</code> adds this theorem to the <code>simp</code> database of theorems it tries to apply.</p>
<p>We can simplify any expression <code>e</code> by using <code>e rewrite_by simp</code>:</p>
<pre><code class="language-lean">#check (0 + 5 + 0) rewrite_by simp
</code></pre>
<p>This returns <code>5 : ℕ</code>, showing that all the zero additions have been eliminated. We can inspect what the simplifier did by turning on some options:</p>
<pre><code class="language-lean">set_option trace.Meta.Tactic.simp.rewrite true in
#check (0 + 5 + 0) rewrite_by simp
</code></pre>
<p>This produces:</p>
<pre><code>[Meta.Tactic.simp.rewrite] @zero_add:1000, 0 + 5 ==&gt; 5
[Meta.Tactic.simp.rewrite] @add_zero:1000, 5 + 0 ==&gt; 5
</code></pre>
<p>We can see that the simplifier first simplifies the subexpression <code>0 + 5</code> to <code>5</code> and then <code>5 + 0</code> to <code>5</code>.</p>
<p>The simplifier has many options and configurations. By default, <code>simp</code> uses all the theorems marked with <code>simp</code>. However, it is often useful to narrow it down to a specific set of theorems. You can do this by using <code>simp only</code>, which does not use any theorems at all, performing only basic lambda calculus reductions, like beta reduction, which turns <code>(fun x =&gt; f x) y</code> into <code>f y</code>. To explicitly specify a set of theorems to use, use square brackets:</p>
<pre><code class="language-lean">#check (0 + 5 + 0) rewrite_by simp only [add_zero]
</code></pre>
<p>This produces <code>0 + 5</code>, as only the rewrite rule <code>add_zero</code> is allowed.</p>
<h2 id="loop-fusion"><a class="header" href="#loop-fusion">Loop Fusion</a></h2>
<p>This theorem illustrates the concept of loop fusion, which is relevant to program optimization. Consider the theorem:</p>
<pre><code class="language-lean">theorem mapMono_mapMono {I} [IndexType I] (x : Float^[I]) (f g : Float → Float) :
    (x.mapMono f |&gt;.mapMono g) = x.mapMono fun x =&gt; g (f x) := ...
</code></pre>
<p>This theorem shows that two <code>mapMono</code> operations can be fused into one. The function <code>mapMono</code> can be implemented with a for loop, so this theorem states that two for loops can be merged into one.</p>
<p>In numerical linear algebra, a common operation is computing <code>a•x+y</code> for <code>a : Float</code>, <code>x</code> and <code>y</code> of type <code>Float^[n]</code>. Scalar multiplication and addition on <code>Float^[n]</code> can be implemented using <code>mapMono</code>, which means that <code>a•x+y</code> contains two loops that can be fused together using the above theorem.</p>
<pre><code class="language-lean">def saxpy {n} (a : Float) (x y : Float^[n]) := (a•x+y)
  rewrite_by
    simp only [HAdd.hAdd, Add.add, HSMul.hSMul, SMul.smul]
    simp only [mapMono_mapIdxMono]
</code></pre>
<p>The <code>saxpy</code> function computes <code>a•x+y</code>, and by adding <code>rewrite_by ...</code>, we rewrite <code>a•x+y</code> to:</p>
<pre><code class="language-lean">x.mapIdxMono fun i x =&gt; a * x + y[i]
</code></pre>
<p>The first <code>simp only</code> command unfolds the definitions of all the arithmetic operations, revealing the use of <code>mapMono</code> and <code>mapIdxMono</code> used to implement arithmetic operations on arrays. The syntax <code>x + y</code> is just a syntactic sugar for <code>HAdd.hAdd x y</code>. If you want to see the actual definitions, you can add <code>set_option pp.notation false</code> somewhere in your file.</p>
<p>Sometimes, it's useful to keep the default or naive implementation of a function intact and only instruct the compiler to use the optimized version when compiling the code. This can be achieved using the <code>def_optimize</code> command.</p>
<p>For example, let's define a naive version of <code>saxpy</code>:</p>
<pre><code class="language-lean">def saxpy_naive {n} (a : Float) (x y : Float^[n]) := a•x+y
</code></pre>
<p>To instruct the compiler to replace <code>saxpy_naive</code> with the optimized version, we use the <code>def_optimize</code> command:</p>
<pre><code class="language-lean">def_optimize saxpy_naive by
  simp only [HAdd.hAdd, Add.add, HSMul.hSMul, SMul.smul]
  simp only [mapMono_mapIdxMono]
</code></pre>
<p>This command creates a new definition <code>saxpy_naive.optimized</code>, which is an optimized version of <code>saxpy_naive</code>. It also creates a new theorem called <code>saxpy_naive.optimize_rule</code>, which states that <code>saxpy_naive = saxpy_naive.optimized</code> and marks it with the <code>@[csimp]</code> attribute. The <code>csimp</code> attribute is similar to <code>simp</code>, but it stands for &quot;compiler simp,&quot; and the corresponding theorems are only applied during compilation.</p>
<h2 id="optimizing-array-indexing"><a class="header" href="#optimizing-array-indexing">Optimizing Array Indexing</a></h2>
<p>Our approach to arrays, allowing indexing with an arbitrary type <code>I</code>, incurs a performance cost as the current Lean compiler can't optimize all layers of abstraction away. However, the flexibility of Lean enables us to engineer such optimizations ourselves without needing to modify the compiler.</p>
<p>Consider matrix-vector multiplication:</p>
<pre><code class="language-lean">def matVecMul {n m} (A : Float^[n,m]) (x : Float^[m]) := ⊞ i =&gt; ∑ j, A[i,j] * x[j]
</code></pre>
<p>Recall that <code>Float^[n,m]</code> stands for <code>DataArrayN Float (Fin n × Fin m)</code>, a data structure indexed by <code>Fin n × Fin m</code>. The generic type <code>A × B</code> presents an issue because currently, any product type is implemented as a pair of pointers. Therefore, the index access <code>A[i,j]</code> first constructs the index <code>(i,j)</code>, which is a pair of pointers to <code>i</code> and <code>j</code>, stored somewhere on the heap. This is highly inefficient. We want to rewrite <code>A[i,j]</code> to <code>A.data.get (i*m+j)</code>, computing the linear index <code>i*m+j</code> and avoiding the construction of the product <code>(i,j)</code>.</p>
<pre><code class="language-lean">def_optimize matVecMul by
  simp only [GetElem.getElem, LeanColls.GetElem'.get, DataArrayN.get, IndexType.toFin, id,
             Fin.pair, IndexType.fromFin, Fin.cast, IndexType.card]
</code></pre>
<p>This optimization results in:</p>
<pre><code class="language-lean">⊞ i =&gt; ∑ j, A.data.get ⟨↑i * m + ↑j, ⋯⟩ * x.data.get ⟨↑j, ⋯⟩
</code></pre>
<p>The optimization simply forces the inlining of the mentioned functions. To simplify this process, there is a tactic <code>optimize_index_access</code> that calls <code>simp</code> with the appropriate settings and theorems.</p>
<p>Next, let's consider the dot product of two matrices:</p>
<pre><code class="language-lean">def matDot {n m} (A B : Float^[n,m]) := ∑ (ij : Fin n × Fin m), A[ij] * B[ij]
</code></pre>
<p>Explicitly mentioning the type of the index <code>ij : Fin n × Fin m</code> highlights that this function again creates the problematic product type. We want to iterate this sum over the range <code>0,...,n*m-1</code> and use this linear index to access the matrices.</p>
<pre><code class="language-lean">def_optimize matDot by
  -- rewrite `sum` over `Fin n × Fin m` to `fold` over `Fin (n*m)`
  rw[sum_linearize]

  -- unfold several layers of abstraction for `get` function
  simp only [GetElem.getElem, LeanColls.GetElem'.get, DataArrayN.get]

  -- simplify `toFin (fromFin i)` to `i`
  simp only [toFin_fromFin]

  -- clean up some expressions
  simp only [Fin.cast,IndexType.card]
</code></pre>
<p>This optimization results in:</p>
<pre><code class="language-lean">∑ (i : Fin (n*m)), A.data.get ⟨↑i,⋯⟩ * B.data.get ⟨↑i,⋯⟩
</code></pre>
<p>This can also be achieved by calling the <code>optimize_index_access</code> tactic in a single line.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../working-with-arrays/tensor-operations.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../working-with-arrays/tensor-operations.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
